<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>M5StickCでベッドサイドのランプをOn/Offする</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@fumiakiy"/><meta name="og:title" content="M5StickCでベッドサイドのランプをOn/Offする"/><meta name="twitter:title" content="M5StickCでベッドサイドのランプをOn/Offする"/><meta name="description" content="実際はSonoff Basic R3が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのはESP32というWifiとBluetoothが入ったマイクロコンピュータであるのがわかったので、ESP32の開発ボードを眺めては何かできないかなあと。"/><meta name="og:description" content="実際はSonoff Basic R3が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのはESP32というWifiとBluetoothが入ったマイクロコンピュータであるのがわかったので、ESP32の開発ボードを眺めては何かできないかなあと。"/><meta name="twitter:description" content="実際はSonoff Basic R3が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのはESP32というWifiとBluetoothが入ったマイクロコンピュータであるのがわかったので、ESP32の開発ボードを眺めては何かできないかなあと。"/><meta property="og:image" content="https://luckypines.com/images/m5stickc.png"/><meta property="twitter:image" content="https://luckypines.com/images/m5stickc.png"/><link rel="prev" href="https://luckypines.com/blog/20200815-m5stickc-http"/><link rel="next" href="https://luckypines.com/blog/20200815-m5stickc-mhz19b"/><meta name="next-head-count" content="14"/><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-50700-3"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EQQB7LRDHC"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag("js", new Date());
  gtag("config", "UA-50700-3");
  gtag('config', 'G-EQQB7LRDHC');

  window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
  
    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };
  
    return t;
  }(document, "script", "twitter-wjs"));
  </script><link rel="alternate" type="application/atom+xml" title="Atom feed for blog by Fumiaki Yoshimatsu" href="https://luckypines.com/feed.atom"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/a233f8e7bb0aab01.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a233f8e7bb0aab01.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a85ef328f9b29345.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a85ef328f9b29345.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-486af065e1564901.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3d28606f68ef858c.js" defer=""></script><script src="/_next/static/chunks/664-6863c832d33388a7.js" defer=""></script><script src="/_next/static/chunks/395-8a7e744d27193a7d.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpostname%5D-b36ac976ecad146c.js" defer=""></script><script src="/_next/static/w12ezk6WF67nUic4mrFs_/_buildManifest.js" defer=""></script><script src="/_next/static/w12ezk6WF67nUic4mrFs_/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap">@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vqPQA.woff) format('woff')}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_7PqPQA.woff) format('woff')}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_Of2PQA.woff) format('woff')}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSV0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSx0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSt0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSd0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSZ0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSh0me8iUI0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSV0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSx0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSt0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSd0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSZ0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSh0me8iUI0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSV0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSx0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSt0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSd0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSZ0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v22/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSh0me8iUI0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><div class="blog"><article class="BlogPost_article__wA_OL"><h1>M5StickCでベッドサイドのランプをOn/Offする</h1><div>8/15/2020, 3:45:54 PM</div><div class="BlogPost_body__N7rlb"><div><a href="/blog/2020-05-23_Sonoff-Basic-R3-------------------f5498b92027b">Sonoff Basic R3で電源コードにWifi経由でコマンドを送れる</a>ようになって数ヶ月。以前に比べて進化した生活を送れてはいるものの、一つとてもめんどくさいことがある。Apple開発者プログラムに年間購読料を納めないと、iOSアプリのProvisioning Profileが一週間でexpireすること。なんで配布するわけでもないアプリを自分のiPhoneでだけ使うために年間1万円もお布施せねばならんのだ。初詣のお賽銭でもそんなに払わないのに。</div>
<div>とかいいつつ、実際は<a href="https://sonoff.tech/product/wifi-diy-smart-switches/basicr3">Sonoff Basic R3</a>が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのは<a href="https://www.espressif.com/en/products/socs/esp32">ESP32というWifiとBluetoothが入ったマイクロコンピュータ</a>であるのがわかったので、<a href="https://www.espressif.com/en/products/devkits">ESP32の開発ボード</a>を眺めては何かできないかなあと。</div>
<h2>WFHとCO2</h2>
<div><a href="https://www.facebook.com/hello.iandco/posts/1186593688375252">弊社も来年の夏まで自宅作業が決定した</a>ので、仕事環境を少し改善しなければと机や椅子を物色してみたものの、狭い部屋にこれ以上家具を置く気にもならなかった。そんな中、<a href="https://bunshun.jp/articles/-/36791">WFHで環境改善の文脈で部屋の二酸化炭素濃度を測るのが流行っている</a>のを知る。これだ。</div>
<div>&quot;Arduino CO2 sensor&quot;とかで検索すると、<a href="https://www.winsen-sensor.com/sensors/co2-sensor/mh-z19b.html">MH-Z19BというCO2センサーがある</a>のがわかった。ArduinoではなくESP32の開発ボードとこのセンサーでCO2濃度をGoogle Sheetか何かに送って可視化するというプロジェクトをやってみよう。</div>
<h2>M5StickCとMH-Z19B</h2>
<div>そういうことをしている例を検索してみたところ、<a href="https://m5stack.com/collections/m5-core/products/stick-c">M5StickC</a>という製品に行き着いた。中にESP32 Picoってのが入ってて、LCD液晶とボタンが2つと、そして汎用IOピンがある。<a href="https://kitto-yakudatsu.com/archives/7286">M5StickCにMH-Z19Bをくっつけて使うためのケースを売っている人もいて</a> (*1)、この組み合わせは成功例があるらしい。これだ。</div>
<pre><code>*1 正確には、MH-Z19Bの利用例を探していてこの記事を見つけ、それでM5StickCというものの存在を初めて知りました。
</code></pre>
<div>M5StickCもMH-Z19BもAmazonで売っているのだが、検索してみるとそれよりだいぶ安い通販サイトがいくつかある。M5StickCはいろんな場所で売っているのだが、MH-Z19BとM5StickCを両方売っていて安いサイトを探し回った結果、<a href="https://www.banggood.com/">Banggood</a>で買うことにした。決め手は、最安ではないもののそれなりに安価で両方売っていることと、<a href="https://www.banggood.com/MH-Z19-MH-Z19B-Infrared-CO2-Sensor-Module-Carbon-Dioxide-Gas-Sensor-for-CO2-Monitor-0-5000ppm-MH-Z19B-NDIR-with-Pin-p-1693604.html?rmmds=search&amp;cur_warehouse=CN">MH-Z19Bにピンをはんだ付けしてあるバージョンを売っている</a>こと。はんだごてを買うよりジャンパーワイヤーを買う方が安いし、まだはんだごてを買うほどのことでもないし。まあこの二酸化炭素センサーをずっと使い続けるならはんだ付けする日も来るかもしれないけど。</div>
<div>説明を読むと、USやカナダにも倉庫を持っていてそこからの発送ならそんなに時間もかからなそうとか。Banggoodの評判を検索するとあまりよろしくないのだが、内容を読むと「洋服を買ったら偽物だった」「クリスマスに欲しかったのに届かなかった」など、いやそれはどうなのよ的なものが多かったので、せいぜい$35だしというわけで、念のためPayPal支払いで7月27日に発注した。</div>
<div>発注して数時間後にはUSPSのトラッキングコードが割り当てられた。しかしそこから8月10日までの二週間、動きは一切なし。8月10日になってNJのUSPSに届き、そこからなぜかPAを経由して8月13日に無事に届いた。USPSのラベルの下に中国語が書かれた別のラベルが貼ってあって、それにはJFK宛てみたいに書いてあったので、結局中国のどこかからどうにかしてJFKに来て、そこから国内発送されたっぽいんだけど、詳細はわからず。でも送料<strong>90セント</strong>、保険70セントで三週間で届いたのでなんの文句もありません。</div>
<div><div class="image-container"><img src="/images/m5stickc.png" alt="M5StickC"/><div class="image-caption">M5StickC</div></div></div>
<h2>M5StickCでベッドサイドランプのON/OFF</h2>
<div>CO2の前にまずは簡単そうなほうをということで、M5StickCをWifiにつなげて、HTTP POSTでコマンドをSonoff Basic R3に送ることで、M5StickCのボタンを押したときにベッドサイドランプをOn/Offできるようにする。M5StickCのWifiでHTTP POSTする方法はそこら中に例があるので詳細は書かないが、一点だけ少しハマった。</div>
<div>Arduinoの<code>setup() -&gt; loop()</code>を使ってプログラムを書いた。まずはArduinoのプログラム例でありがちな、<code>loop()</code>の中でなんらかの処理をして、<code>delay(1000)</code>とかで1秒寝てから<code>return</code>し、次<code>のloop()</code>が呼ばれる、みたいなコードを書いた。その<code>loop</code>の中で<code>M5.BtnA.isPressed()</code>を見て「ボタンが押されたら...」というコードを書いたんだが、ボタンを押しても全然反応しない。</div>
<div><code>M5.update()</code>で状態を更新した後、<code>M5.BtnA.isPressed()</code>を見ると今その瞬間にボタンが押されたのかどうかがわかるという仕組みなので、<code>delay(1000)</code>とかやってると、その1秒間のどこかでボタンを押しても、次に調べたときには<code>isPressed</code>はもう見えなくなっているってことだと思う。</div>
<div>結局、<code>loop()</code>のなかで<code>delay</code>して処理を1秒ごとにするようなことはやめて、<code>loop()</code>はクロックに応じて実行されるのだが、中で現在時刻を<code>millis()</code>で取って、以前の<code>millis</code>と比較して、1000ms経過してたら処理する、ってなコードに変更してうまくいった。</div>
<pre><code>unsigned long lastMillis = 0;
unsigned long tick = 0;
unsigned long INTERVAL = 1000; // 1sec

void loop() {
  M5.update();
  unsigned long currentMillis = millis();
  if (currentMillis - lastMillis &gt; INTERVAL) {
    statusUpdate(tick++);
    lastMillis = millis();
  }
  if (M5.BtnA.isPressed()) {
    toggleSwitch();
    powerOff();
  }
}
</code></pre>
<div>この機能を使うのは、夜寝る前にランプをONにするときと、寝る直前にOFFにするときだけなので、ONやOFFにしたらその度に本体の電源を切ることにした。M5StickCには小さいバッテリーが入っているので、こまめに電源を切っておけば結構長いこと充電なしで使えるはず。</div>
<div>ソース: <a href="https://github.com/fumiakiy/M5StickC/commit/c64dc7fb78ee0732c97ae0a726fbdf3e2940c4a1">https://github.com/fumiakiy/M5StickC/</a></div>
<div><a href="/blog/20200815-m5stickc-mhz19b">次はCO2センサーにかかろう</a>と思う。</div></div></article></div><footer class="BlogPost_footer__4tSVP"><a class="BlogPost_prev__r_UG_" href="/blog/20200815-m5stickc-http/">« <!-- -->M5StickCでベッドサイドのランプをOn/Offする</a><a href="/blog/">Blog</a><a class="BlogPost_next__kILUp" href="/blog/20200815-m5stickc-mhz19b/">M5StickCとMH-Z19Bで部屋の二酸化炭素を計測して記録する<!-- --> » </a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"slug":"/blog/20200815-m5stickc-http","date":"Sat, 15 Aug 2020 22:45:54 GMT","title":"M5StickCでベッドサイドのランプをOn/Offする","epoch":"1597531554","excerpt":"実際はSonoff Basic R3が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのはESP32というWifiとBluetoothが入ったマイクロコンピュータであるのがわかったので、ESP32の開発ボードを眺めては何かできないかなあと。","ogImage":"/images/m5stickc.png"},"markdownBody":"\n[Sonoff Basic R3で電源コードにWifi経由でコマンドを送れる](/blog/2020-05-23_Sonoff-Basic-R3-------------------f5498b92027b)ようになって数ヶ月。以前に比べて進化した生活を送れてはいるものの、一つとてもめんどくさいことがある。Apple開発者プログラムに年間購読料を納めないと、iOSアプリのProvisioning Profileが一週間でexpireすること。なんで配布するわけでもないアプリを自分のiPhoneでだけ使うために年間1万円もお布施せねばならんのだ。初詣のお賽銭でもそんなに払わないのに。\n\nとかいいつつ、実際は[Sonoff Basic R3](https://sonoff.tech/product/wifi-diy-smart-switches/basicr3)が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのは[ESP32というWifiとBluetoothが入ったマイクロコンピュータ](https://www.espressif.com/en/products/socs/esp32)であるのがわかったので、[ESP32の開発ボード](https://www.espressif.com/en/products/devkits)を眺めては何かできないかなあと。\n\n## WFHとCO2\n\n[弊社も来年の夏まで自宅作業が決定した](https://www.facebook.com/hello.iandco/posts/1186593688375252)ので、仕事環境を少し改善しなければと机や椅子を物色してみたものの、狭い部屋にこれ以上家具を置く気にもならなかった。そんな中、[WFHで環境改善の文脈で部屋の二酸化炭素濃度を測るのが流行っている](https://bunshun.jp/articles/-/36791)のを知る。これだ。\n\n\"Arduino CO2 sensor\"とかで検索すると、[MH-Z19BというCO2センサーがある](https://www.winsen-sensor.com/sensors/co2-sensor/mh-z19b.html)のがわかった。ArduinoではなくESP32の開発ボードとこのセンサーでCO2濃度をGoogle Sheetか何かに送って可視化するというプロジェクトをやってみよう。\n\n## M5StickCとMH-Z19B\n\nそういうことをしている例を検索してみたところ、[M5StickC](https://m5stack.com/collections/m5-core/products/stick-c)という製品に行き着いた。中にESP32 Picoってのが入ってて、LCD液晶とボタンが2つと、そして汎用IOピンがある。[M5StickCにMH-Z19Bをくっつけて使うためのケースを売っている人もいて](https://kitto-yakudatsu.com/archives/7286) (*1)、この組み合わせは成功例があるらしい。これだ。\n\n```\n*1 正確には、MH-Z19Bの利用例を探していてこの記事を見つけ、それでM5StickCというものの存在を初めて知りました。\n```\n\nM5StickCもMH-Z19BもAmazonで売っているのだが、検索してみるとそれよりだいぶ安い通販サイトがいくつかある。M5StickCはいろんな場所で売っているのだが、MH-Z19BとM5StickCを両方売っていて安いサイトを探し回った結果、[Banggood](https://www.banggood.com/)で買うことにした。決め手は、最安ではないもののそれなりに安価で両方売っていることと、[MH-Z19Bにピンをはんだ付けしてあるバージョンを売っている](https://www.banggood.com/MH-Z19-MH-Z19B-Infrared-CO2-Sensor-Module-Carbon-Dioxide-Gas-Sensor-for-CO2-Monitor-0-5000ppm-MH-Z19B-NDIR-with-Pin-p-1693604.html?rmmds=search\u0026cur_warehouse=CN)こと。はんだごてを買うよりジャンパーワイヤーを買う方が安いし、まだはんだごてを買うほどのことでもないし。まあこの二酸化炭素センサーをずっと使い続けるならはんだ付けする日も来るかもしれないけど。\n\n説明を読むと、USやカナダにも倉庫を持っていてそこからの発送ならそんなに時間もかからなそうとか。Banggoodの評判を検索するとあまりよろしくないのだが、内容を読むと「洋服を買ったら偽物だった」「クリスマスに欲しかったのに届かなかった」など、いやそれはどうなのよ的なものが多かったので、せいぜい$35だしというわけで、念のためPayPal支払いで7月27日に発注した。\n\n発注して数時間後にはUSPSのトラッキングコードが割り当てられた。しかしそこから8月10日までの二週間、動きは一切なし。8月10日になってNJのUSPSに届き、そこからなぜかPAを経由して8月13日に無事に届いた。USPSのラベルの下に中国語が書かれた別のラベルが貼ってあって、それにはJFK宛てみたいに書いてあったので、結局中国のどこかからどうにかしてJFKに来て、そこから国内発送されたっぽいんだけど、詳細はわからず。でも送料**90セント**、保険70セントで三週間で届いたのでなんの文句もありません。\n\n![M5StickC](/images/m5stickc.png)\n\n## M5StickCでベッドサイドランプのON/OFF\n\nCO2の前にまずは簡単そうなほうをということで、M5StickCをWifiにつなげて、HTTP POSTでコマンドをSonoff Basic R3に送ることで、M5StickCのボタンを押したときにベッドサイドランプをOn/Offできるようにする。M5StickCのWifiでHTTP POSTする方法はそこら中に例があるので詳細は書かないが、一点だけ少しハマった。\n\nArduinoの`setup() -\u003e loop()`を使ってプログラムを書いた。まずはArduinoのプログラム例でありがちな、`loop()`の中でなんらかの処理をして、`delay(1000)`とかで1秒寝てから`return`し、次`のloop()`が呼ばれる、みたいなコードを書いた。その`loop`の中で`M5.BtnA.isPressed()`を見て「ボタンが押されたら...」というコードを書いたんだが、ボタンを押しても全然反応しない。\n\n`M5.update()`で状態を更新した後、`M5.BtnA.isPressed()`を見ると今その瞬間にボタンが押されたのかどうかがわかるという仕組みなので、`delay(1000)`とかやってると、その1秒間のどこかでボタンを押しても、次に調べたときには`isPressed`はもう見えなくなっているってことだと思う。\n\n結局、`loop()`のなかで`delay`して処理を1秒ごとにするようなことはやめて、`loop()`はクロックに応じて実行されるのだが、中で現在時刻を`millis()`で取って、以前の`millis`と比較して、1000ms経過してたら処理する、ってなコードに変更してうまくいった。\n\n```\nunsigned long lastMillis = 0;\nunsigned long tick = 0;\nunsigned long INTERVAL = 1000; // 1sec\n\nvoid loop() {\n  M5.update();\n  unsigned long currentMillis = millis();\n  if (currentMillis - lastMillis \u003e INTERVAL) {\n    statusUpdate(tick++);\n    lastMillis = millis();\n  }\n  if (M5.BtnA.isPressed()) {\n    toggleSwitch();\n    powerOff();\n  }\n}\n```\n\nこの機能を使うのは、夜寝る前にランプをONにするときと、寝る直前にOFFにするときだけなので、ONやOFFにしたらその度に本体の電源を切ることにした。M5StickCには小さいバッテリーが入っているので、こまめに電源を切っておけば結構長いこと充電なしで使えるはず。\n\nソース: [https://github.com/fumiakiy/M5StickC/](https://github.com/fumiakiy/M5StickC/commit/c64dc7fb78ee0732c97ae0a726fbdf3e2940c4a1)\n\n[次はCO2センサーにかかろう](/blog/20200815-m5stickc-mhz19b)と思う。\n\n","navs":{"nextPage":{"epoch":"1597587411","title":"M5StickCとMH-Z19Bで部屋の二酸化炭素を計測して記録する","slug":"/blog/20200815-m5stickc-mhz19b"},"prevPage":{"epoch":"1597531554","title":"M5StickCでベッドサイドのランプをOn/Offする","slug":"/blog/20200815-m5stickc-http"}}},"__N_SSG":true},"page":"/blog/[postname]","query":{"postname":"20200815-m5stickc-http"},"buildId":"w12ezk6WF67nUic4mrFs_","runtimeConfig":{},"isFallback":false,"gsp":true}</script></body></html>