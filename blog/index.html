<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-50700-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {dataLayer.push(arguments); }
    gtag("js", new Date());

    gtag("config", "UA-50700-3");
 </script><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&amp;display=swap" rel="stylesheet"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Blog | Fumiaki Yoshimatsu</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/821d38573be5c4e706f6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/821d38573be5c4e706f6.css"/><link rel="preload" href="/_next/static/css/dcc794658ddc85b4309d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dcc794658ddc85b4309d.css"/><link rel="preload" href="/_next/static/chunks/main-fd8a0b253a51098ec3a6.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-488dc228921f1fdbc0e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.1b5fae6dde8a26be77ac.js" as="script"/><link rel="preload" href="/_next/static/chunks/e82d01500e11e0131e78851aa17fd9f5e63d6c88.616ccd5db4903f86882e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7fedf4f2cd6f1ab3e039.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog-28dab01dc9e079f7ef39.js" as="script"/></head><body><div id="__next"><main><h1 class="BlogIndex_heading__1DB3T">Blog</h1><ul class="BlogIndex_list__2chVO"><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">M5StickCとMH-Z19Bで部屋の二酸化炭素を計測して記録する</h2><div class="BlogIndex_excerpt__39xiA">
[前回](/blog/20200815-m5stickc-http)からの続き。

## MH-Z19B

![M5StickCとMH-Z19B](/images/m5stickc-mhz19b.png)

[MH-Z19B](https://www.winsen-sensor.com/sensors/co2-sensor/mh-z19b.html)を[M5StickC](https://m5s...</div><div class="BlogIndex_date__F1VyT">Sun, 16 Aug 2020 14:16:51 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">M5StickCでベッドサイドのランプをOn/Offする</h2><div class="BlogIndex_excerpt__39xiA">
[Sonoff Basic R3で電源コードにWifi経由でコマンドを送れる](https://medium.com/@fumiakiy/f5498b92027b)ようになって数ヶ月。以前に比べて進化した生活を送れてはいるものの、一つとてもめんどくさいことがある。Apple開発者プログラムに年間購読料を納めないと、iOSアプリのProvisioning Profileが一週間でexpireするこ...</div><div class="BlogIndex_date__F1VyT">Sat, 15 Aug 2020 22:45:54 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">[Android] Horizontal scroll list in vertically scrolling list, and how to handle “ItemClick” event fired by each item</h2><div class="BlogIndex_excerpt__39xiA">

One thing I would have liked to implement in the all new Peatix Android app was this idea of “Home” screen. It shows what are relevant to you regardless of what type of objects they are. Very much l...</div><div class="BlogIndex_date__F1VyT">Thu, 30 Apr 2015 16:07:59 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Butter Knife vs Android Annotations</h2><div class="BlogIndex_excerpt__39xiA">

There was a tech conference geared towards Android app developers, #DroidKaigi in Japan. I wasn’t able to attend unfortunately because it happened in Tokyo while I was in New York, but thanks to the...</div><div class="BlogIndex_date__F1VyT">Sat, 25 Apr 2015 23:04:24 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">This is so awesome I can’t help but posting it here.</h2><div class="BlogIndex_excerpt__39xiA">
This is so awesome I can’t help but posting it here.

From [http://www.mobileattack.com/android/another-wallpaper-apple-sliced-by-android-jedi/](http://www.mobileattack.com/android/another-wallpaper-...</div><div class="BlogIndex_date__F1VyT">Wed, 04 Mar 2015 16:34:15 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Unit testing Android app using Robolectric and Android Studio 1.0.1</h2><div class="BlogIndex_excerpt__39xiA">        
I have been reluctant to write tests for my Android projects because…

1.  I didn’t really know what to test. TextView.is.visible.and.hasText(“Hello World”). Er, um.
2.  I did write some test...</div><div class="BlogIndex_date__F1VyT">Tue, 16 Dec 2014 20:16:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">第3回　宮川達彦―最先端のWebエンジニアのキャリア：エンジニアの生存戦略｜gihyo.jp … 技術評論社</h2><div class="BlogIndex_excerpt__39xiA">

[bulknews](http://weblog.bulknews.net/post/105334762130/3-web-gihyo-jp):

&gt; &gt; 先を歩むエンジニアへのインタビューを通してエンジニアのキャリアについて考える本連載，今回は古くからPerlコミュニティで活躍し，最近ではWebテクノロジ情報発信のポッドキャスト「Rebuild」が話題の宮川達彦さんにお話を伺いました。
&gt; ...</div><div class="BlogIndex_date__F1VyT">Tue, 16 Dec 2014 18:16:21 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Twitter Login using TwitterKit but without TwitterLoginButton</h2><div class="BlogIndex_excerpt__39xiA">        
[Fabric](http://dev.twitter.com) is awesome. It was the happiest experience of my professional life when it was about to installing a SDK, when it was Fabric’s.

The app I was working on requ...</div><div class="BlogIndex_date__F1VyT">Fri, 12 Dec 2014 03:25:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Android Studio v1.0.0 and you can&#x27;t build your project any more... here is how I fixed my project.</h2><div class="BlogIndex_excerpt__39xiA">
It’s v1.0 time! Android Studio is updated. My project which uses Android Annotations and Proguard failed to build after the update with pretty cryptic messages.

After a few minutes digging, I was ab...</div><div class="BlogIndex_date__F1VyT">Tue, 09 Dec 2014 05:03:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">On not following my passion</h2><div class="BlogIndex_excerpt__39xiA">
Mike Rowe’s response to why he thought people should not follow his/her passion is getting a buzz. To simply summarize it, he argues that one should not follow one’s passion for too long because many...</div><div class="BlogIndex_date__F1VyT">Mon, 06 Oct 2014 19:43:50 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Mike Rowe&#x27;s must-read response to an Alabamian who asked why he shouldn&#x27;t follow his passion - Yellowhammer News</h2><div class="BlogIndex_excerpt__39xiA">
&gt; When it comes to earning a living and being a productive member of society – I don’t think people should limit their options to those vocations they feel passionate towards.\[…\]

http://yellowhamm...</div><div class="BlogIndex_date__F1VyT">Mon, 06 Oct 2014 18:33:07 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Microservices, history iterates, etc</h2><div class="BlogIndex_excerpt__39xiA">

It was in an episode of [#rebuildfm](http://rebuild.fm) where I heard the term [microservices](http://martinfowler.com/articles/microservices.html) for the first time. It sounded nothing new to me, ...</div><div class="BlogIndex_date__F1VyT">Fri, 29 Aug 2014 18:52:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">他人の理想のために生きてないわ。自分が生きたいように生きるし、言いたいことを言う！ - Darvish Yu</h2><div class="BlogIndex_excerpt__39xiA">
[https://twitter.com/faridyu/status/502102389202370560](https://twitter.com/faridyu/status/502102389202370560)</div><div class="BlogIndex_date__F1VyT">Wed, 20 Aug 2014 15:04:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">やりたいことは本当はすごく沢山あって   だけど大体の物は既にあるわけじゃないですか。
既にある物に勝つためには
優れたアイデアか   あと20年続けるモチベーション
のどちらかが必要だと思います。</h2><div class="BlogIndex_excerpt__39xiA">

まつもとゆきひろさん

（ Rebuild.fm EP53 [http://rebuild.fm/53/](http://rebuild.fm/53/) )</div><div class="BlogIndex_date__F1VyT">Thu, 14 Aug 2014 21:47:25 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">On Startups: How we develop new features extremely fast</h2><div class="BlogIndex_excerpt__39xiA">

[eventjoy](http://blog.eventjoy.com/post/87807448121/on-startups-how-we-develop-new-features-extremely-fast):

&gt; It’s no secret that we’re a small team, two people to be exact. Yet, people constantl...</div><div class="BlogIndex_date__F1VyT">Thu, 05 Jun 2014 03:26:11 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Covert Redirect Vulnerability with OAuth 2</h2><div class="BlogIndex_excerpt__39xiA">

[bulknews](http://weblog.bulknews.net/post/85008516879/covert-redirect-vulnerability-with-oauth-2):

&gt; **tl;dr** Covert Redirect Vulnerability is a real, if not new, threat when combined with Implic...</div><div class="BlogIndex_date__F1VyT">Thu, 08 May 2014 02:27:45 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">On being an OP of OpenID Connect</h2><div class="BlogIndex_excerpt__39xiA">

The more I understand OpenID Connect, the more I understand that it is really only for those few big guys, when it comes to a server implementation.

Looking at some code and spec and it sounds easy...</div><div class="BlogIndex_date__F1VyT">Sun, 16 Mar 2014 21:43:57 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Is OpenID Connect a new version of OpenID?</h2><div class="BlogIndex_excerpt__39xiA">

Short answer: who cares?

Tl;dr; no.

OpenID Connect seems getting traction. As one of implementers of an OpenID and OpenID 2.0 implementations, I am very curious about why the foundation keeps usin...</div><div class="BlogIndex_date__F1VyT">Sun, 09 Mar 2014 19:34:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">My first public presentation in English</h2><div class="BlogIndex_excerpt__39xiA">

Due to our CEO’s absence, I took the stage of one of the greatest meetup around the world, New York Tech Meetup last night, to introduce ColorSync. You can watch it here until it would be taken down...</div><div class="BlogIndex_date__F1VyT">Thu, 06 Mar 2014 04:12:10 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Why did I want to stop using jQuery as much as I can and move on to AngularJS</h2><div class="BlogIndex_excerpt__39xiA">

I didn’t like to use jQuery very much when I started building Peatix. What I didn’t like most was the fact that by merely writing $(’.class-yeah-its-just-a-marker’) you could jump here from there an...</div><div class="BlogIndex_date__F1VyT">Sun, 16 Feb 2014 21:01:02 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Moved to T-Mobile</h2><div class="BlogIndex_excerpt__39xiA">

I have been on Straight Talk $45 plan for two months after I got a Nexus 5. It has been very fine (I’m in Manhattan, New York most of the time) but I used the line in a very limited amount of time.
...</div><div class="BlogIndex_date__F1VyT">Sun, 09 Feb 2014 20:54:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">David Heinemeier Hansson at Startup School 2008</h2><div class="BlogIndex_excerpt__39xiA">

David Heinemeier Hansson at Startup School 2008 (with slides)

[https://www.youtube.com/watch?v=0CDXJ6bMkMY](https://www.youtube.com/watch?v=0CDXJ6bMkMY)

It was from 5 years ago??? Yet it is so rel...</div><div class="BlogIndex_date__F1VyT">Wed, 05 Feb 2014 21:01:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Collecting pictures using Instagram API</h2><div class="BlogIndex_excerpt__39xiA">

Instagram has an API. That’s good. But its document was a little bit confusing to me. This is how I ended up implementing Perl code that populates Instagram pictures that have a hashtag of my intere...</div><div class="BlogIndex_date__F1VyT">Sun, 02 Feb 2014 20:33:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Migrating Google login from OpenID 2.0 to Google+ (Part 3 of 3)</h2><div class="BlogIndex_excerpt__39xiA">
([Part 1 of this story](/blog/migrating-google-login-from-openid-20-to-google-1))

Google+ Sign In returns id_token that is a JWT encoded information of various stuff related to the account, along wi...</div><div class="BlogIndex_date__F1VyT">Sun, 26 Jan 2014 18:03:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)</h2><div class="BlogIndex_excerpt__39xiA">

([Part 1 of this story](/blog/migrating-google-login-from-openid-20-to-google-1))


Google published an article in December 2013 that says &quot;[Upgrading to Google+ Sign In](https://developers.google.c...</div><div class="BlogIndex_date__F1VyT">Sun, 26 Jan 2014 17:15:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Migrating Google login from OpenID 2.0 to Google+ (Part 1 of 3)</h2><div class="BlogIndex_excerpt__39xiA">

We&#x27;ve been allowing users to use their Google accounts to login to Peatix. Until yesterday, however, the code was based on OpenID 2.0 protocol.

```
commit   
Author: Fumiaki Yoshimatsu  
Date: Mon ...</div><div class="BlogIndex_date__F1VyT">Sun, 26 Jan 2014 16:30:00 GMT</div></div></li><li class="BlogIndex_card__n8qQN"><div class="BlogIndex_cardContent__3ZvWS"><h2 class="BlogIndex_title__2nSxf">Reloaded</h2><div class="BlogIndex_excerpt__39xiA">

It’s been a while since I posted the last entry to my blog. Two years later, I think I thought I’d restart blogging again.

</div><div class="BlogIndex_date__F1VyT">Sun, 26 Jan 2014 15:55:29 GMT</div></div></li></ul></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"posts":[{"frontmatter":{"slug":"/blog/20200815-m5stickc-mhz19b","date":"Sun, 16 Aug 2020 14:16:51 GMT","title":"M5StickCとMH-Z19Bで部屋の二酸化炭素を計測して記録する","epoch":"1597587411","excerpt":"MH-Z19BをM5StickCに接続して、CO2センサーのデータを読み取ってGoogle Sheetに記録するプログラムを書く。","ogImage":"/images/m5stickc-mhz19b-complete.png"},"markdownBody":"\n[前回](/blog/20200815-m5stickc-http)からの続き。\n\n## MH-Z19B\n\n![M5StickCとMH-Z19B](/images/m5stickc-mhz19b.png)\n\n[MH-Z19B](https://www.winsen-sensor.com/sensors/co2-sensor/mh-z19b.html)を[M5StickC](https://m5stack.com/collections/m5-core/products/stick-c)に接続して、CO2センサーのデータを読み取ってGoogle Sheetに記録するプログラムを書く。\n\nまずMH-Z19BについてるピンとM5StickCを接続する。MH-Z19Bに電力を供給するために、MH-Z19Bの`Vinピン`とM5StickCの`5V out`をつなぎ、MH-Z19Bの`GNDピン`とM5StickCの`GND`をつなぐ。MH-Z19BからデータをM5StickCで読み取るために、MH-Z19Bの`Txピン`とM5StickCの`G0`、MH-Z19Bの`Rxピン`とM5StickCの`G26`をつなぐ。M5StickC側のGPIOピンはなんでもいいっぽいが、つないだピン番号をコードに書く必要がある（後述）。\n\n| | |\n| --------- | ------- |\n| [![MH-Z19Bのピン接続](/images/mhz19b-pins.png)](/images/mhz19b-pins.png)| [![M5StickCのピン接続](/images/m5stickc-pins.png)](/images/m5stickc-pins.png) |\n\n## MH-Z19Bのデータを読むコード\n\n接続できたらM5StickCでデータを読むコードを書く。日本語で書かれたM5StickCでMH-Z19Bを扱う記事を読むと、[UIFlowでPythonでコードを書いている例](https://kitto-yakudatsu.com/archives/7286#toc21)や[M5CloudでPythonを使う例](https://medium.com/tichise/m5stack%E3%81%A7%E5%AE%B6%E3%81%A8%E3%82%AA%E3%83%95%E3%82%A3%E3%82%B9%E3%81%AE%E4%BA%8C%E9%85%B8%E5%8C%96%E7%82%AD%E7%B4%A0%E6%BF%83%E5%BA%A6%E3%82%92%E8%A8%88%E6%B8%AC%E3%81%97%E3%81%9F-3553f7a1434d)が出てきてArduino/Cなコードが出てこなくて一瞬焦ったが、ArduinoのLibrary Managerで[MH-Z19を検索して出てくるライブラリ](https://github.com/WifWaf/MH-Z19)を`#include`して普通に使えた。\n\n実際のコードを書くときにライブラリの[examples/BasicUsage](https://github.com/WifWaf/MH-Z19/blob/master/examples/BasicUsage/BasicUsage.ino)を参考にしたんだが、M5StickCで使う場合は一部コメントアウトされている方を使う必要があったりする。別にポイントってほどのことではないが、Serial1をbeginで開くときに指定する実引数でボーレート(BAUDRATE)を9600にして、上述のTxとRxの番号を指定することで正しくデータを読み取れるようになる。この辺がサンプルコードの中では`HardwareSerial`になっていたり(`Serial1`でよい)、RX_PINとTX_PINの値が違っていたり(M5StickCではGPIO10やGPIO11へのアクセスはない)するが、まあ見ればわかるって話だと思う。[ESP32にはSerial1とSerial2っていう系統があるっていうのはこの記事で知った](https://lang-ship.com/blog/work/m5stickc-uartserial/)。\n\nソース: [https://github.com/fumiakiy/M5StickC/](https://github.com/fumiakiy/M5StickC/commit/6038aa3dbb8ade0c36a88142eef4f365a9dece8a#diff-ac3ed53726558e3635fc88015490f1bc)\n\n![CO2センサー完成。気温は高めに出る。](/images/m5stickc-mhz19b-complete.png)\n\n\n## Google Sheetに記録するコード\n\nCO2センサーのデータをSerialに出力してそれっぽいデータが取れていることが確認できたので、これをGoogle Sheetに送って記録しておくことにする。Google SheetにひもづけたApp ScriptをWeb Deployすれば勝手にHTTPのエンドポイントを作ってくれるので、下記のような単純なApp Scriptで、HTTP POSTでJSONを受け取ってGoogle Sheetに追加できる。\n\n```\nfunction writeData(ar) {\n  const d = new Date()\n  const aar = [...ar, d.getTime(), d.toLocaleString()]\n  const sheet = SpreadsheetApp.getActiveSheet();\n  sheet.insertRowBefore(1);\n  sheet.getRange(1, 1, 1, aar.length).setValues([aar])\n}\n\nfunction doPost(e) {\n  const d = e.postData.contents;\n  const j = JSON.parse(d);\n  writeData(j);\n  return ContentService.createTextOutput(\"ok\");\n}\n```\n\nこのコードをWeb DeployすればURLが割り当てられるので、それに対してM5StickCからHTTP POSTすればよい。めんどくさいので認証は省いてURLを知っていれば誰でもアクセスできるようにしちゃった。\n\nソース: [https://github.com/fumiakiy/M5StickC/](https://github.com/fumiakiy/M5StickC/commit/07fb585184442a125a88a250bdc4a14d8c23076b#diff-ac3ed53726558e3635fc88015490f1bc)\n\nあとは1日データを溜めて、グラフ化してみよう。"},{"frontmatter":{"slug":"/blog/20200815-m5stickc-http","date":"Sat, 15 Aug 2020 22:45:54 GMT","title":"M5StickCでベッドサイドのランプをOn/Offする","epoch":"1597531554","excerpt":"実際はSonoff Basic R3が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのはESP32というWifiとBluetoothが入ったマイクロコンピュータであるのがわかったので、ESP32の開発ボードを眺めては何かできないかなあと。","ogImage":"/images/m5stickc.png"},"markdownBody":"\n[Sonoff Basic R3で電源コードにWifi経由でコマンドを送れる](https://medium.com/@fumiakiy/f5498b92027b)ようになって数ヶ月。以前に比べて進化した生活を送れてはいるものの、一つとてもめんどくさいことがある。Apple開発者プログラムに年間購読料を納めないと、iOSアプリのProvisioning Profileが一週間でexpireすること。なんで配布するわけでもないアプリを自分のiPhoneでだけ使うために年間1万円もお布施せねばならんのだ。初詣のお賽銭でもそんなに払わないのに。\n\nとかいいつつ、実際は[Sonoff Basic R3](https://sonoff.tech/product/wifi-diy-smart-switches/basicr3)が楽しかったので味をしめて、何かIoT的なおもちゃでもっと遊べないかなあと思っていた。Sonoff Basic R3を調べる中で、要するにおもしろいのは[ESP32というWifiとBluetoothが入ったマイクロコンピュータ](https://www.espressif.com/en/products/socs/esp32)であるのがわかったので、[ESP32の開発ボード](https://www.espressif.com/en/products/devkits)を眺めては何かできないかなあと。\n\n## WFHとCO2\n\n[弊社も来年の夏まで自宅作業が決定した](https://www.facebook.com/hello.iandco/posts/1186593688375252)ので、仕事環境を少し改善しなければと机や椅子を物色してみたものの、狭い部屋にこれ以上家具を置く気にもならなかった。そんな中、[WFHで環境改善の文脈で部屋の二酸化炭素濃度を測るのが流行っている](https://bunshun.jp/articles/-/36791)のを知る。これだ。\n\n\"Arduino CO2 sensor\"とかで検索すると、[MH-Z19BというCO2センサーがある](https://www.winsen-sensor.com/sensors/co2-sensor/mh-z19b.html)のがわかった。ArduinoではなくESP32の開発ボードとこのセンサーでCO2濃度をGoogle Sheetか何かに送って可視化するというプロジェクトをやってみよう。\n\n## M5StickCとMH-Z19B\n\nそういうことをしている例を検索してみたところ、[M5StickC](https://m5stack.com/collections/m5-core/products/stick-c)という製品に行き着いた。中にESP32 Picoってのが入ってて、LCD液晶とボタンが2つと、そして汎用IOピンがある。[M5StickCにMH-Z19Bをくっつけて使うためのケースを売っている人もいて](https://kitto-yakudatsu.com/archives/7286) (*1)、この組み合わせは成功例があるらしい。これだ。\n\n```\n*1 正確には、MH-Z19Bの利用例を探していてこの記事を見つけ、それでM5StickCというものの存在を初めて知りました。\n```\n\nM5StickCもMH-Z19BもAmazonで売っているのだが、検索してみるとそれよりだいぶ安い通販サイトがいくつかある。M5StickCはいろんな場所で売っているのだが、MH-Z19BとM5StickCを両方売っていて安いサイトを探し回った結果、[Banggood](https://www.banggood.com/)で買うことにした。決め手は、最安ではないもののそれなりに安価で両方売っていることと、[MH-Z19Bにピンをはんだ付けしてあるバージョンを売っている](https://www.banggood.com/MH-Z19-MH-Z19B-Infrared-CO2-Sensor-Module-Carbon-Dioxide-Gas-Sensor-for-CO2-Monitor-0-5000ppm-MH-Z19B-NDIR-with-Pin-p-1693604.html?rmmds=search\u0026cur_warehouse=CN)こと。はんだごてを買うよりジャンパーワイヤーを買う方が安いし、まだはんだごてを買うほどのことでもないし。まあこの二酸化炭素センサーをずっと使い続けるならはんだ付けする日も来るかもしれないけど。\n\n説明を読むと、USやカナダにも倉庫を持っていてそこからの発送ならそんなに時間もかからなそうとか。Banggoodの評判を検索するとあまりよろしくないのだが、内容を読むと「洋服を買ったら偽物だった」「クリスマスに欲しかったのに届かなかった」など、いやそれはどうなのよ的なものが多かったので、せいぜい$35だしというわけで、念のためPayPal支払いで7月27日に発注した。\n\n発注して数時間後にはUSPSのトラッキングコードが割り当てられた。しかしそこから8月10日までの二週間、動きは一切なし。8月10日になってNJのUSPSに届き、そこからなぜかPAを経由して8月13日に無事に届いた。USPSのラベルの下に中国語が書かれた別のラベルが貼ってあって、それにはJFK宛てみたいに書いてあったので、結局中国のどこかからどうにかしてJFKに来て、そこから国内発送されたっぽいんだけど、詳細はわからず。でも送料**90セント**、保険70セントで三週間で届いたのでなんの文句もありません。\n\n![M5StickC](/images/m5stickc.png)\n\n## M5StickCでベッドサイドランプのON/OFF\n\nCO2の前にまずは簡単そうなほうをということで、M5StickCをWifiにつなげて、HTTP POSTでコマンドをSonoff Basic R3に送ることで、M5StickCのボタンを押したときにベッドサイドランプをOn/Offできるようにする。M5StickCのWifiでHTTP POSTする方法はそこら中に例があるので詳細は書かないが、一点だけ少しハマった。\n\nArduinoの`setup() -\u003e loop()`を使ってプログラムを書いた。まずはArduinoのプログラム例でありがちな、`loop()`の中でなんらかの処理をして、`delay(1000)`とかで1秒寝てから`return`し、次`のloop()`が呼ばれる、みたいなコードを書いた。その`loop`の中で`M5.BtnA.isPressed()`を見て「ボタンが押されたら...」というコードを書いたんだが、ボタンを押しても全然反応しない。\n\n`M5.update()`で状態を更新した後、`M5.BtnA.isPressed()`を見ると今その瞬間にボタンが押されたのかどうかがわかるという仕組みなので、`delay(1000)`とかやってると、その1秒間のどこかでボタンを押しても、次に調べたときには`isPressed`はもう見えなくなっているってことだと思う。\n\n結局、`loop()`のなかで`delay`して処理を1秒ごとにするようなことはやめて、`loop()`はクロックに応じて実行されるのだが、中で現在時刻を`millis()`で取って、以前の`millis`と比較して、1000ms経過してたら処理する、ってなコードに変更してうまくいった。\n\n```\nunsigned long lastMillis = 0;\nunsigned long tick = 0;\nunsigned long INTERVAL = 1000; // 1sec\n\nvoid loop() {\n  M5.update();\n  unsigned long currentMillis = millis();\n  if (currentMillis - lastMillis \u003e INTERVAL) {\n    statusUpdate(tick++);\n    lastMillis = millis();\n  }\n  if (M5.BtnA.isPressed()) {\n    toggleSwitch();\n    powerOff();\n  }\n}\n```\n\nこの機能を使うのは、夜寝る前にランプをONにするときと、寝る直前にOFFにするときだけなので、ONやOFFにしたらその度に本体の電源を切ることにした。M5StickCには小さいバッテリーが入っているので、こまめに電源を切っておけば結構長いこと充電なしで使えるはず。\n\nソース: [https://github.com/fumiakiy/M5StickC/](https://github.com/fumiakiy/M5StickC/commit/c64dc7fb78ee0732c97ae0a726fbdf3e2940c4a1)\n\n[次はCO2センサーにかかろう](/blog/20200815-m5stickc-mhz19b)と思う。\n\n"},{"frontmatter":{"slug":"/blog/android-horizontal-scroll-list-in-vertically","date":"Thu, 30 Apr 2015 16:07:59 GMT","title":"[Android] Horizontal scroll list in vertically scrolling list, and how to handle “ItemClick” event fired by each item","epoch":"1430410079"},"markdownBody":"\n\nOne thing I would have liked to implement in the all new Peatix Android app was this idea of “Home” screen. It shows what are relevant to you regardless of what type of objects they are. Very much like Google Now, which shows many different types of “cards” in one list.\n\nIn the list, I want to show as many “stuff” as possible in a small screen of a phone. The app could list things like tickets you have got, list of events the app recommends to you, tweets and FB posts related to an event you are going, etc etc. Lining up all of these items vertically in a scrolling view is an okay-idea; but it’s pretty obvious that the latter an item is listed, the latter it’s going to be actually seen (or to impress the user). As of this writing, Facebook and Twitter both put relevant items in vertically scrolling list, while some items (mostly Ads, some photos if there are many) occupies only a height of an item while showing many child items in horizontally scrolling list. I would have liked that in my app too.\n\nYou can see the guts of what I implemented in [one of my GitHub repositories](https://github.com/fumiakiy/HorizontalScrollSample). Here in [this commit I implemented very basic vertically scrolling list](https://github.com/fumiakiy/HorizontalScrollSample/commit/45af3bd8cbcad3fea1cf5ac256f6a07359a2a9cc) by using RecyclerView and its friends. Then I [added “ItemClick” event handler](https://github.com/fumiakiy/HorizontalScrollSample/commit/f8ff3871aa9ffa0684faf50c7febc4bcf08f6c4c) in the next commit. Simple, so far.\n\nNow I want to modify some of those items have its own child items that are horizontally scrolling. I added another layout XML that has a RecyclerView. So, the root RecyclerView has list of CardViews. Each CardView renders either [a text](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/res/layout/list_item_text.xml) or [another RecyclerView](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/res/layout/list_item_horizontal_parent.xml). Basically, many RecyclerViews are nested inside a RecyclerView. Each child RecyclerView has as many items its adapter gives it, and [renders each item using (happens to be) the same layout as is used in the parent RecyclerView to render a simple text](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/java/com/luckypines/horizontalscrollsample/HorizontalItemsViewHolder.java#L22). So far so good.\n\nThe last but the hardest part to implement in a way that makes sense to me is to handle “ItemClick” event fired by each child items in a horizontally scrolling item. The very first idea that comes to my mind is to define OnItemClickListener in the [ViewHolder](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/java/com/luckypines/horizontalscrollsample/HorizontalItemsViewHolder.java). If you think about it, each of the parent items in the vertically scrolling list fires the event to the handler that MainActivity defines; the same structure should work, so it’s natural for each ViewHolder to define OnItemClickListener for each of its own children.\n\nBut I dumped the idea because it didn’t make sense to me. ViewHolder should be a reusable utility class for a type of View/Layout rendered in a RecyclerView. It must not be tied to a particular item. But in order to implement OnItemClickListener, an instance of ViewHolder must know about either the list of items that its parent RecyclerView is rendering, or each item that is rendered. The latter makes the ViewHolder un-reusable. The former idea, well, having a reference in something that could be discarded at any point (RecyclerView aggressively recycles views) make hard the fighting NullPointerException.\n\nThese are what I have thought through, to conclude [my implementation of having both ItemClickListener (children and grandchildren)](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/java/com/luckypines/horizontalscrollsample/MainActivity.java#L96-L114) in MainActivity.\n\nIt first detects if if’s a “touch-up” event. It then finds an item that must be under where the touch event occurs. If an item is a type of String, it fires the direct child’s OnItemClick (well, virtually said. It does what the event handler does inline in the example). If an item is not a type of String, it must be an array of String in this case, which means the item is a horizontally scrolling CardView. It [calculates offset to the CardView](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/java/com/luckypines/horizontalscrollsample/MainActivity.java#L105) and [pass the calculated coordinates to the ViewHolder’s method to get a grand child item](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/java/com/luckypines/horizontalscrollsample/HorizontalItemsViewHolder.java#L25). If the position of a grand child item is found, it looks for the grand child and fires OnChildItemClick (again, it writes [what it does in line](https://github.com/fumiakiy/HorizontalScrollSample/blob/master/app/src/main/java/com/luckypines/horizontalscrollsample/MainActivity.java#L108-L109)). Woot. Mission accomplished.\n\nI am not saying that this is the best way to handle these stuff though. I have a part of myself who doesn’t like this complicated implementation. Implementing ViewHolder pattern correctly is hard.\n\nPlease let me know what I am doing wrong if you see it. Thanks for reading thus far.\n\n"},{"frontmatter":{"slug":"/blog/butter-knife-vs-android-annotations","date":"Sat, 25 Apr 2015 23:04:24 GMT","title":"Butter Knife vs Android Annotations","epoch":"1430003064"},"markdownBody":"\n\nThere was a tech conference geared towards Android app developers, #DroidKaigi in Japan. I wasn’t able to attend unfortunately because it happened in Tokyo while I was in New York, but thanks to the folks who share most everything to the Internet, I could feel how it went. It sounds it went really well. Congratulations to the event organizers.\n\nOne thing that got me when I was reading those blogs and summaries about the conference was that [Butter Knife](http://jakewharton.github.io/butterknife/) sounded more popular and better loved by them than [Android Annotations](http://androidannotations.org/). I just sent a new Android app to our quality assurance process. The app was completely written from scratch by myself, which uses Android Annotations everywhere and I was a little concerned that I might have chosen the wrong library (again…?).\n\nBut it turned out that I wasn’t that much wrong. Butter Knife solves a problem that Android Annotations also solves, but it doesn’t have a critical part (for me) that Android Annotations helped me a lot while working on my app; Extra, FragmentArg and InstanceState.\n\nWithout these annotations, I have had to write \\_very correct\\_ code to handle saveInstanceState and onCreate and everything else. Now it might sound trivial - you just have to pass objects to an Activity you are starting and the code to handle them is well pattern-ed by now - but when it comes to handling orientation changes it gets incredibly hard to write “the correct” code. Fortunately, Android Annotations does the right thing for you with this tiny cost of you have to be careful that you are going to start Activity\\_ (with the trailing underscore), not the Activity you write (AndroidManifest.xml).\n\nTo be honest, we did have problems with Android Annotations in developing the previous versions of our app, especially with EFragment and AfterViews injections, but it turned out it was our fault - mostly because we wrote code that does “view initialization” in AfterViews methods, which turned out to be called every time the view is created. In Android, orientation changes destroy views and they are recreated. With some of those “gotchas” in mind, Android Annotations served really well for me this time.\n\nTo make it a little clear, I didn’t write code that use Butter Knife. I didn’t use EBean, EService, Rest or any other fancy attributes that Android Annotations offer either. EActivity, EFragment, ViewById, Click, OptionsMenu, OptionsItem, Extra, FragmentArg, and InstanceState are the ones I used and loved. I might try to use some more in the upcoming versions, but those only still make significant difference. I understand when someone say Android Annotations is simple overkill; it did concern me when I think of those unused features that Android Annotations offer, but hey, I managed to keep away from [Guava](https://github.com/google/guava) and the app still compiles without [multidex](https://developer.android.com/tools/building/multidex.html) enabled.\n\nI will write more about what I learned when I was writing the Android app soon.\n\n"},{"frontmatter":{"slug":"/blog/this-is-so-awesome-i-cant-help-but-posting-it","date":"Wed, 04 Mar 2015 16:34:15 GMT","title":"This is so awesome I can’t help but posting it here.","epoch":"1425486855"},"markdownBody":"\nThis is so awesome I can’t help but posting it here.\n\nFrom [http://www.mobileattack.com/android/another-wallpaper-apple-sliced-by-android-jedi/](http://www.mobileattack.com/android/another-wallpaper-apple-sliced-by-android-jedi/)\"\n\n![Image](https://64.media.tumblr.com/5e003a545527fe2f1e5349f6630cf612/tumblr_nkp4p3HvW21qz65w3o1_1280.jpg)"},{"frontmatter":{"slug":"/blog/unit-testing-android-app-using-robolectric-and","date":"Tue, 16 Dec 2014 20:16:00 GMT","title":"Unit testing Android app using Robolectric and Android Studio 1.0.1","epoch":"1418760960"},"markdownBody":"        \nI have been reluctant to write tests for my Android projects because…\n\n1.  I didn’t really know what to test. TextView.is.visible.and.hasText(“Hello World”). Er, um.\n2.  I did write some tests as experiments. It runs and start activities in my device. If I didn’t connect my device to my mac, it runs in the emulator. It is slow and it does destruct my focus on writing code.\n\n[At one of the greatest meetup experience of any kind that was held at Spotify NYC office by NY Android developers meetup group](http://www.meetup.com/android-developers-nyc/events/219023775/), I learned less painful ways of doing unit tests for Android dev. [Robolectric](http://robolectric.org/). It allows an Android project to run inside JUnit/IDE. Woot! I have got to try that.\n\nI thought that Robolectric was mostly a drop-in replacement of a standard Android testing framework that is installed when you create a new project in Android Studio. I was wrong. It took 8 hours worth of my spare time to get it finally working with \\`gradlew test\\` inside the Terminal window of Android Studio 1.0.1. It took another 4 hours to figure out running on JUnit test runner inside Android Studio 1.0.1 IDE.\n\nInstead of writing in a human readable language on how I made it work, I compiled my journey into a stream of commits in my GitHub repository. It should address many if not most of the issues you would be facing if you start doing the same stuff by yourself. I saw a lot of StackOverflow questions about it. Some of them are still applicable to Android Studio 1.0, but many of them were stale (don’t get me wrong. They were really helpful for me to figuring out where to look at. I appreciate it. That is why I list most of them in this writing later).\n\n[GitHub repository “AndroidAppWithRobolectricUnitTestsInAS101” by fumiakiy](https://github.com/fumiakiy/AndroidAppWithRobolectricUnitTestsInAS101)\n\nSo, try it by yourself (may be with some help from [my GitHub repository](https://github.com/fumiakiy/AndroidAppWithRobolectricUnitTestsInAS101)) and enjoy writing unit tests with [Robolectric](http://robolectric.org/) inside Android Studio 1.0.1!\n\nHere is the list of most helpful links that I found during my journey of making it all work.\n\n*   [https://github.com/robolectric/deckard-gradle](https://github.com/robolectric/deckard-gradle)\n    \n    This is the default “installation” suggested by Robolectric. It works. The contents of build.gradle are what I copied to the first half of my “MyApplication” project. But simply importing all gradle settings fails MyApplication because Robolectric currently supports API level 18 and the project Android Studio 1.0.1 creates targets 21.\n    \n*   [http://stackoverflow.com/questions/23867341/android-robolectric-does-not-support-api-level-1](http://stackoverflow.com/questions/23867341/android-robolectric-does-not-support-api-level-1)\n    \n    This SO is where I found a solution to API level issue. This one also reminded me that there are more than a few configuration you can specify in @Config annotation.\n    \n*   [https://github.com/square/assertj-android/issues/129#issuecomment-62205520](https://github.com/square/assertj-android/issues/129#issuecomment-62205520)\n    \n    After I added [AssertJ Android](http://square.github.io/assertj-android/) (that I also learned at the meetup), I started to see a build error again. This “temporary” solution is still required as of this writing to solve the issue.\n    \n*   [https://github.com/robolectric/robolectric/issues/1018](https://github.com/robolectric/robolectric/issues/1018)\n    \n    ResourceNotFoundException wasn’t there for the first time I started this “project”, but it was because I changed MainActivity extends from Activity. The default was ActionBarActivity that Android Studio 1.0.1 generates, which raises the ResourceNotFoundException. This thread helped me find “qualifiers” attribute. But the suggested value “v10” didn’t work because I was using suport library 21.0.3 which has “v11”.\n    \n*   [http://blog.blundell-apps.com/android-gradle-app-with-robolectric-junit-tests/](http://blog.blundell-apps.com/android-gradle-app-with-robolectric-junit-tests/) and [http://blog.blundell-apps.com/how-to-run-robolectric-junit-tests-in-android-studio/](http://blog.blundell-apps.com/how-to-run-robolectric-junit-tests-in-android-studio/)\n    \n    After I was satisified with running tests by \\`gradlew test\\`, I added JUnit configuration to the project so the tests can run inside IDE with some nice visual and debuggability. It failed in many ways. These tutorials by Blundell helped me a lot to figure out how to run it in the IDE. The document was not for Android Studio 1.0.1 and some information may be stale and not applicable by now (for example, I didn’t have to specify Alt JRE, and I didn’t have to create a “testClasses” gradle configuration), but I wasn’t able to figure out to do it by creating a Java library outside of the app project and refer to the app project from it, without these tutorials.\n    \n*   [https://github.com/robolectric/robolectric/issues/1334](https://github.com/robolectric/robolectric/issues/1334)\n    \n    I wasn’t able to “reproduce” this particular error when I was compiling my findings one step at a time, but I am sure I was hit by the error. This thread was where I found project.properties can specify libraries to look at. But later I found that you can also put library path to @Config attribute, which was handier for this project.\n    \n\nThanks to all of you who keeps records of what works and what doesn’t work. Hope this entry and [my GitHub repository](https://github.com/fumiakiy/AndroidAppWithRobolectricUnitTestsInAS101) also serve somebody in the future.\n\nLast but not the least, Thanks [Sean Kenny who did the presentation at the meetup](https://docs.google.com/presentation/d/1eF9B9Yi1SIGRxCrKQMhJbCFQQRf3RCuYNk0Ofos5FWE/edit). I also had to say thanks to [Erik Hellman who also did another great presentation at the meetup](https://docs.google.com/presentation/d/1e2jIRPc03BCfDi8wTWvvtipPsANru4KqbMkhYXfM1AI/edit). OMG, Spotify sounds like a great place to work. Thanks [New York Android Developers Meetup](http://www.meetup.com/android-developers-nyc/). I learned a lot from them.\n\n"},{"frontmatter":{"slug":"/blog/3-web-gihyojp","date":"Tue, 16 Dec 2014 18:16:21 GMT","title":"第3回　宮川達彦―最先端のWebエンジニアのキャリア：エンジニアの生存戦略｜gihyo.jp … 技術評論社","epoch":"1418753781"},"markdownBody":"\n\n[bulknews](http://weblog.bulknews.net/post/105334762130/3-web-gihyo-jp):\n\n\u003e \u003e 先を歩むエンジニアへのインタビューを通してエンジニアのキャリアについて考える本連載，今回は古くからPerlコミュニティで活躍し，最近ではWebテクノロジ情報発信のポッドキャスト「Rebuild」が話題の宮川達彦さんにお話を伺いました。\n\u003e \n\u003e WEB+DB Vol.83 で対談した記事がウェブで読めるようになってました。だらだらとしゃべっていましたが、うまいことまとまっていると思います :)\n\u003e \n\u003e [対談後に収録した Aftershow](http://rebuild.fm/64/) も合わせてどうぞ。\n\nhttp://gihyo.jp/lifestyle/serial/01/survival\\_strategy\\_engineer/0003"},{"frontmatter":{"slug":"/blog/twitter-login-using-twitterkit-but-without","date":"Fri, 12 Dec 2014 03:25:00 GMT","title":"Twitter Login using TwitterKit but without TwitterLoginButton","epoch":"1418354700"},"markdownBody":"        \n[Fabric](http://dev.twitter.com) is awesome. It was the happiest experience of my professional life when it was about to installing a SDK, when it was Fabric’s.\n\nThe app I was working on require Twitter login, and Fabric provides code that does heavy lifting for it. Unfortunately, [the documentation Twitter provides explains only about how to use the TwitterLoginButton](https://dev.twitter.com/twitter-kit/android/twitter-login) which I didn’t want to use, not because I didn’t like the design but the app I was writing required a smaller button.\n\nSo I dig a little bit of its code through Android Studio, another awesome software which made me love to write code in Java and for Android apps. I found a way to use my own button to go through what TwitterKit requires an app to do.\n\nYou just need to create a new TwitterAuthClient instance and call authorize method of it. It launches an activity and comes back to the calling activity (yours) by onActivityResult event. You handle the callback by sending the data again to authclient instance and that’s about it.\n\nSample code is on my github. \n\n[https://github.com/fumiakiy/CustomButtonTwitterLogin](https://github.com/fumiakiy/CustomButtonTwitterLogin)\n\n"},{"frontmatter":{"slug":"/blog/android-studio-v100-and-you-cant-build-your","date":"Tue, 09 Dec 2014 05:03:00 GMT","title":"Android Studio v1.0.0 and you can't build your project any more... here is how I fixed my project.","epoch":"1418101380"},"markdownBody":"\nIt’s v1.0 time! Android Studio is updated. My project which uses Android Annotations and Proguard failed to build after the update with pretty cryptic messages.\n\nAfter a few minutes digging, I was able to make it build again by applying the following patch.\n\n```\n--- a/app/build.gradle\n+++ b/app/build.gradle\n@@ -7,7 +7,7 @@ buildscript {\n     }\n     dependencies {\n         // replace with the current version of the Android plugin\n-        classpath 'com.android.tools.build:gradle:0.12.+'\n+        classpath 'com.android.tools.build:gradle:1.0.0'\n         // Since Android's Gradle plugin 0.11, you have to use android-apt \u003e= 1.3\n         classpath 'com.neenbedankt.gradle.plugins:android-apt:1.4+'\n@@ -28,7 +28,7 @@ \n\n apt {\n     arguments {\n-        androidManifestFile variant.processResources.manifestFile\n+        androidManifestFile variant.outputs\\[0\\].processResources.manifestFile\n         resourcePackageName android.defaultConfig.applicationId\n\n         // If you're using Android NBS flavors you should use the following line\n         // instead of hard-coded packageName\n@@ -53,14 +53,14 @@ android {\n     }\n     buildTypes {\n         release {\n-            runProguard true\n+            minifyEnabled true\n             proguardFiles getDefaultProguardFile('proguard.txt'), 'proguard-rules.pro'\n         }\n         debug {\n-            runProguard false\n+            minifyEnabled false\n         }\n         staging {\n-            runProguard true\n+            minifyEnabled true\n             proguardFiles getDefaultProguardFile('proguard.txt'), 'proguard-rules.pro'\n         }\n```         \n\nJust postin' for someone including future myself who could struggle with it...\n\n"},{"frontmatter":{"slug":"/blog/on-not-following-my-passion","date":"Mon, 06 Oct 2014 19:43:50 GMT","title":"On not following my passion","epoch":"1412624630"},"markdownBody":"\nMike Rowe’s response to why he thought people should not follow his/her passion is getting a buzz. To simply summarize it, he argues that one should not follow one’s passion for too long because many if not most cannot reach there anyway; and he believes those people should see it earlier rather than later to make their lives happier.\n\nI am not rich. I am not even close to be rich at all. I am not what I thought I would want to be when I was younger. I wanted to be a journalist. I wanted to make my living by telling others stories from the rest of the world in “a journalistic way”. But I wasn’t able to even start my carrier as a journalist. I was employed by a systems integrator after I failed all of my applications to most of the newspaper publishers in Japan when I graduated school.\n\nBut I can safely say I am very fortunate to be where I am. Not because now those newspaper companies are struggling; but because I found what I would love during my tenure since then. It turned out I loved writing software to solve someone else’s problem.\n\nThe first batch of “programs” I wrote - or more like I typed - was games printed on magazines. Basic Magazine and later I/O. I had fun with it with my brother sitting next to me. I took basic computer programming classes of Natural Science division when I finished getting most of grade points to graduate college with my major. But it never got me until I was assigned to the R\u0026D department at the second year at my first company when I found that I loved, and was very good at, learning something new about computer software and telling people about my learning by writing and speaking. That was when my carrier really has started.\n\nI could have followed my heart and have tried harder to be a journalist, by for example spend a whole year abroad and apply for the next year’s new hire opportunity. I was too scared of doing that. Instead I grabbed a job that wasn’t what I thought I would be - a programmer. Since then, like someone that Mike Rowe shared in his response, “I found a way to love it”. With a little bit of luck of department assignment.\n\nI am in no way eligible to telling someone else something to do or something not to do; I am nobody anyway. But I can say to myself now that I am doing what I wanted to do, by “telling people what I learned about the world”; That world may be smaller, or virtual world of computer programs. Bonus is that I am paid to do it and colleagues around me (I believe) thinks I am doing it good.\n\n"},{"frontmatter":{"slug":"/blog/mike-rowes-must-read-response-to-an-alabamian-who","date":"Mon, 06 Oct 2014 18:33:07 GMT","title":"Mike Rowe's must-read response to an Alabamian who asked why he shouldn't follow his passion - Yellowhammer News","epoch":"1412620387"},"markdownBody":"\n\u003e When it comes to earning a living and being a productive member of society – I don’t think people should limit their options to those vocations they feel passionate towards.\\[…\\]\n\nhttp://yellowhammernews.com/faithandculture/alabamian-gets-schooled-mike-rowe-dirty-jobs/"},{"frontmatter":{"slug":"/blog/microservices-history-iterates-etc","date":"Fri, 29 Aug 2014 18:52:00 GMT","title":"Microservices, history iterates, etc","epoch":"1409338320"},"markdownBody":"\n\nIt was in an episode of [#rebuildfm](http://rebuild.fm) where I heard the term [microservices](http://martinfowler.com/articles/microservices.html) for the first time. It sounded nothing new to me, but it’s among the latest buzzwords.\n\nInter process communication\n---------------------------\n\nI started my carrier as an instructor/conference speaker at around 1995. Windows NT 3.51 finally made threads available to COM based applications through it’s intrduction of MTA (multi-threaded apartment). COM or Component Object Model was a technology that enabled inter-application communication through OLE2 (Object Linking and Embeddding). OLE(1) enabled an Excel speadsheet be embedded in an Word document. OLE2 made a step further and made the underlying technology available to 3rd party developers through COM. In other words, it was unix pipe for a Windows GUI application. Inter-process communication took place on top of COM’s intra-process, inter-thread communication.\n\nInter-machine communication\n---------------------------\n\nWith Windows NT 4 in 1996, Microsoft took a step even further and introduced DCOM, or Distributed COM. By 1996 with help by popularity of Windows 95, corporate intra-network became pretty popular. Client-Server system. Visual Basic application connected to Oracle 6 database. 3-tier, Windows DNA. Inter-machine communication took place. DCOM tried to solve the problem around programs communicates over machine boundary by leveraging COM inter-process communication.\n\nIt allowed programmers feel as if they were writing code that communicated with other COM interfaces over process boundary, even when they were writing code that actually communicated over machine boundary, over corporate, 100Base-T LAN.\n\nDCOM even introduced DCOM over HTTP later so COM interfaces can be exposed over the Internet.\n\nJ2EE/EJB, CORBA, the same story, different companies involved.\n\nSOAP\n----\n\nSOAP, or Simple Object Access Protocol, was born to make inter-machine communication over HTTP a reality. RPC can be replaced with HTTP protocol. Network data representation (NDR) can be replaced with an XML document. But SOAP is still a protocol for Object-RPC systems. It had been so until SOAP version 1.2. It was a tragedy for SOAP that SOAP v1.1 became too popular. Most dummy implementations of it naively believe RPC calls should look the same to programmers regardless of how long “the wire” was. SOAP 1.2 is a messaging protocol. It specifies a message format in XML Infoset which aimed to create an abstraction layer on top of XML document which is defined as text.\n\nSOAP 1.2 defines headers and bodies and processing models; it looks very much like what HTTP is being used today. SOAP 1.2 was intended to use more transfer protocols than just HTTP because HTTP was text based and thought to be slow; SOAP over SMTP could also be possible; SOAP could also be used even in-process communication (XML Infoset can be serialized to a binary format). It was too late; when Microsoft introduced .NET Framework, even most product managers in Microsoft still saw SOAP to see objects, at the time .NET objects written in C#. WSDL does have a way to define document oriented interface as well as legacy, rpc oriented interface. Document oriented interface never became popular. “Wise” brains started to criticize how stupid the idea was to event think about doing RPC over the wire. Coarse-grained messages. Messages, not method calls. Services not objects. Service oriented architecture.\n\nSOA\n---\n\nIt was interesting few months of my carrier during these days, because I was also able to see that there was the other side of the world. Blue pill? Red pill?\n\nIn the other side of thew world, Movable Type made trackback familiar. Dave Winer advocates RSS 0.91 and 2.0. RSS reader applications. NOKIA lifeblog protocol that can post an entry to TypePad from your cellphone.\n\nThese are based on this simple notion - sending an XML document over HTTP (be it GET or POST), is very usable for inter-process communication, without a concrete specification on which all tech giants agree. View source. Blog hacks. (I feel funny that Fiddler the sniffer became very popular these days. It was during these days I first used Fiddler and loved it until I switched to Mac.)\n\nAnd Google Maps. Ajax is not very much a “protocol” but more like a good old client-server communication. Its JavaScript calls fine grained methods. Google servers are fast enough to process that many number of method calls fast.\n\nThere was this buzzword - SOA during the timeframe around my carrier. In SOA, all participating endpoints agree not only on a protocol and a processing model, but they also agree on a very concrete “business process document schema”, at least in their ideal world. RosettaNet, BPEL, BizTalk.\n\nOn the other side though, Ajax exploded. RPC between JavaScript on a browser and an HTTP endpoint got popular among programmers once again. It does feel easier to architect coarse grained message with these important idea of “connections can be lost; messages can be half-broken, etc, etc”. All you do is call a simple method like “add(1, 2)” and get “3” as a result. Programmers love it. RPC is easier than Messaging.\n\nIt was SOA and this idea of “all parties agree on an XML schema” that finished me in that part of the world. It was a ridiculous idea to me given trackbacks and RSS were already working in practice out there.\n\nI joined Amazon as a technical evangelist, to adovoate to programmers. that this part of the world was more fun. I wrote magazine articles about it. I talked about it at some tech conferences. I let other programmers know how fun it would be to write code that does internetwork communication through “API” until I realized it would be fun for me too. I stopped talking and started writing code at Six Apart.\n\nWell now what?\n--------------\n\nFast forward a few years, I am still writing code that is getting large codebase. Some parts in my code communicate inside the system itself, but over HTTP. I heard the word microservices. Where limited number of coarse grained messages are transferred between services in a system. Wait, is this deja vu?\n\nNo, I guess not, partly because it is still about a monolithic system (if you can call “Amazon.com” a monolithic system). It is not about Amazon.com communicates with Google.com (which was what SOA circa 2005 was trying to accomplish). Also everybody in this generation understands that calling an endpoint over HTTP is way more expensive than calling a method inside a process. C10K problems.\n\nWell defined interface, but the parties who must agree on that interfaces are still within a firewall. History doesn’t just repeat; it iterates like it draws a spiral.\n\nI do feel sad when this generation points fingers at and laughs at SOAP/WSDL though. It surely served my carrier. I even feel grateful to Microsoft to adapt to SOAP, for if it were not them, I wasn’t aware of those XML related stuff until a few years later, which should have made my carrier very different.\n\nBy the way, COM taught me this thing called interface based programming too. COM interfaces have functions but not data. COM is not OO - you start by writing an interface definition by this language called IDL. Doesn’t it sound familiar?\n\n"},{"frontmatter":{"slug":"/blog/darvish","date":"Wed, 20 Aug 2014 15:04:00 GMT","title":"他人の理想のために生きてないわ。自分が生きたいように生きるし、言いたいことを言う！ - Darvish Yu","epoch":"1408547040"},"markdownBody":"\n[https://twitter.com/faridyu/status/502102389202370560](https://twitter.com/faridyu/status/502102389202370560)"},{"frontmatter":{"slug":"/blog/matsumoto","date":"Thu, 14 Aug 2014 21:47:25 GMT","title":"やりたいことは本当はすごく沢山あって   だけど大体の物は既にあるわけじゃないですか。\n既にある物に勝つためには\n優れたアイデアか   あと20年続けるモチベーション\nのどちらかが必要だと思います。","epoch":"1408052845"},"markdownBody":"\n\nまつもとゆきひろさん\n\n（ Rebuild.fm EP53 [http://rebuild.fm/53/](http://rebuild.fm/53/) )"},{"frontmatter":{"slug":"/blog/on-startups-how-we-develop-new-features-extremely","date":"Thu, 05 Jun 2014 03:26:11 GMT","title":"On Startups: How we develop new features extremely fast","epoch":"1401938771"},"markdownBody":"\n\n[eventjoy](http://blog.eventjoy.com/post/87807448121/on-startups-how-we-develop-new-features-extremely-fast):\n\n\u003e It’s no secret that we’re a small team, two people to be exact. Yet, people constantly ask us how we’re able to roll out so many large features so quickly. We thought we’d share our design and development process. To do this we’ll use our brand new iOS attendee app as a case study.  \n\u003e \n\u003e **1. Use…**\n\nhttp://blog.eventjoy.com/post/87807448121/on-startups-how-we-develop-new-features-extremely-fast"},{"frontmatter":{"slug":"/blog/covert-redirect-vulnerability-with-oauth-2","date":"Thu, 08 May 2014 02:27:45 GMT","title":"Covert Redirect Vulnerability with OAuth 2","epoch":"1399516065"},"markdownBody":"\n\n[bulknews](http://weblog.bulknews.net/post/85008516879/covert-redirect-vulnerability-with-oauth-2):\n\n\u003e **tl;dr** Covert Redirect Vulnerability is a real, if not new, threat when combined with Implicit Grant Flow (not Code flow)\n\u003e \n\u003e This [Covert Redirect Vulnerability](http://tetraph.com/covert_redirect/oauth2_openid_covert_redirect.html) in OAuth 2 is an interesting one.\n\u003e \n\u003e There’s a couple of [defending](http://www.thread-safe.com/2014/05/covert-redirect-and-its-real-impact-on.html) [arguments](http://dannythorpe.com/2014/05/02/tech-analysis-of-serious-security-flaw-in-oauth-openid-discovered/) that this isn’t a flaw in OAuth itself.\n\u003e \n\u003e While I agree that…\n\nOpenID Connect mandates full length matching in redirect\\_uri validation according to other blogs, which should be good enough to avoid this problem, I guess. I have to check spec and implementation though.\n\nhttp://weblog.bulknews.net/post/85008516879/covert-redirect-vulnerability-with-oauth-2"},{"frontmatter":{"slug":"/blog/on-being-an-op-of-openid-connect","date":"Sun, 16 Mar 2014 21:43:57 GMT","title":"On being an OP of OpenID Connect","epoch":"1395006237"},"markdownBody":"\n\nThe more I understand OpenID Connect, the more I understand that it is really only for those few big guys, when it comes to a server implementation.\n\nLooking at some code and spec and it sounds easy to be an Open ID provider (i.e. a server), for it’s as simple as implementing OAuth2 server. But this id\\_token thing is new for me. I got used to using Facebook’s signed\\_request, but only as a client or a relying party. Now when it comes to becoming a server, it seems you must implement this mechanism by yourself.\n\nComponents that construct id\\_token are freely available out there - JSON WebToken, Base64, and HMAC signatures. But the real problem is that you have to manage the cryptographic signature that you rely on very carefully. For example, Google rotates its public key every day (and it says it’s cacheable! is it really?). If it is one of reference implementations, I have to implement it in a similar way too. Sigh.\n\nThis alone makes me believ the points made in my previous entry stronger - this is really only for big guys. If you can’t do this, you can’t afford storing people’s passwords in your system.\n\nI personally have no problem asking Google and Facebook to behave as my identity provider for all websites that require my information to do some awesome stuff. But I also know, as one of those online service providers, that people do hate logging in via a third party token; they prefer give us their email addresses and passwords. It’s likely due to experiences that hurt these people when they gave a service their Facebook access\\_token; a service may have posted something embarrassing on behalf of them, for example.\n\nThose who had hard time in that way may have learned that giving garbage email address and using 1password is the safest way because most service providers like us are potentially evil. All of us.\n\nI wonder how OpenID Connect crosses this hurdle - becoming a server is hard and that may be fine, but it is a big problem if using it as a client (RP) may not help a service grow its user base because of the very issue OpenID Foundation is trying to tackle - our passwords may have to be stored in these many places because that is what users want us to do.\n\n"},{"frontmatter":{"slug":"/blog/is-openid-connect-a-new-version-of-openid","date":"Sun, 09 Mar 2014 19:34:00 GMT","title":"Is OpenID Connect a new version of OpenID?","epoch":"1394393640"},"markdownBody":"\n\nShort answer: who cares?\n\nTl;dr; no.\n\nOpenID Connect seems getting traction. As one of implementers of an OpenID and OpenID 2.0 implementations, I am very curious about why the foundation keeps using the term OpenID with it.\n\nOpenID, to me, was a revolution started by a few brightest minds of our generation. Its aim was to be “a decentralized identity system, but one that’s actually decentralized and doesn’t entirely crumble if one company turns evil or goes out of business.” ([The top page of OpenID.net in 2005)](http://web.archive.org/web/20050924033518/http://www.danga.com/openid/).\n\nIs OpenID Connect still a decentralized identity system that doesn’t crumble if Facebook or Google or AOL or whichever internet giant goes out of business? No, it is not something like that. But who cares? If they go, everybody goes.\n\nIt has been that way OpenID evolved since OpenID 2.0, which allows you to start an authentication process by merely stating you are one of an account holders of “yahoo.com”. OpenID, because it is to verify that you own your own domain such as “www.lukypines.com”, always had to ask you to enter “http://www.luckypines.com”, or just for another example, “http://itsme.yahoo.com” (it is not a valid URI as of this writing). Neither Yahoo nor Google gives each user account its specific subdomain, like LiveJournal and TypePad did, like other hip services did too at that time. So that made insufficient for a person to be an account holder in Google, Yahoo, AOL, … to have him/herself to be an OpenID verified identity because s/he doesn’t own a domain.\n\nOpenID 2.0 solved the problem by adding OP Identifier to the spec. Instead of asking a user a domain s/he owns, it allowed a user to tell a relying party a domain owned by one of internet giants who should identify the user on behalf.\n\nAt this point, OpenID 2.0 becomes a protocol for a select few centralized identity providers, which only a few internet giants could manage your identity. It may be open because the protocol is open, and there are many reference implementations that are open source. but OpenID 2.0 is not “a decentralized identification system” any more.\n\nIt was interesting that OpenID was “a visionary’s tool that never got much commercial adoption” for the OpenID foundation, and OpenID 2.0 had adoption problems because it relies on XML (“[What is the history of OpenID?” - http://openid.net/connect/faq/](http://openid.net/connect/faq/)).\n\nThose are probably true; as one of Six Apart employees (2006 - 2010), I saw OpenID implementations everywhere; but those are all by visionaries and none was by those giants. It was a start-up project. I saw a lot of implementations of many many things that relied on XML. But those were not by someones who should be considered majority enough.\n\nNow, finally, OpenID Connect launches. It’s not even an OpenID 3.0. It’s just a profile of OAuth 2.0. I am confused; why shouldn’t it be OAuth 2.0 + Authentication Profile? I mean, those concerns that OpenID Foundation raises are valid; relying too much on HTTP redirection don’t work well in this native mobile app eco-system. XML is a thing in the past; JSON is the only pragmatic option of serializing an opaque data between two computer systems and communicate them over the wire. But it doesn’t solve the problem in a way the visionaries saw in OpenID. Why does it have to be a version of OpenID?\n\nI may be feeling a little too nostalgic; it was good old days for me when everything around me looked brighter. I am not saying OpenID Connect or OpenID Foundation is a BS. As a matter of fact I’ll implement it to our own service soon. But I can’t help but feeling uncomfortable when someone says it is the “Identity Layer of the Internet”, when all it does is to encourage us to rely on very small number of giants and forget about my owning my own identity. OpenID encouraged me to be free from authority; OpenID Connect encourages me to rely on it.\n\nYes, I’m interested in [Camilstore](https://camlistore.org/) too although I haven’t done anything with it yet.\n\n"},{"frontmatter":{"slug":"/blog/my-first-public-presentation-in-english","date":"Thu, 06 Mar 2014 04:12:10 GMT","title":"My first public presentation in English","epoch":"1394079130"},"markdownBody":"\n\nDue to our CEO’s absence, I took the stage of one of the greatest meetup around the world, New York Tech Meetup last night, to introduce ColorSync. You can watch it here until it would be taken down (I’ll appear at around 31:10).\n\n[http://mlb.mlb.com/media/player/entry.jsp?calendar\\_event\\_id=14-403620-2014-03-04\u0026source=NYTM](http://mlb.mlb.com/media/player/entry.jsp?calendar_event_id=14-403620-2014-03-04\u0026source=NYTM)\n\nIt was supposed to be a 3 minutes lightning talk. 3 minutes! I have never done anything that short. It was also an introduction to our product, for which people in the company has different opinion about what to talk. But in the end I ignored most of the suggestions because of two reasons; it wouldn’t be anything closer to good if I didn’t speak what I thought I’d talk in 3 minutes in my second language. And I was also pretty confident of myself being able to give a good talk. After all, I used to be a professional conference speaker for more than five years. No colleagues in the office saw my speaking, so it was understandable that they were worried about me. But it was what I was very good at doing. Now they must know. I see very positive tweets which makes me proud.  \nThe question now is, should I seek more opportunities to talk about something in public? I found that it was surprisingly comfortable giving the talk last night. Maybe I should. But then the next question is if I have something to talk about which could be interesting to audiences. That, I must answer myself.\n\n"},{"frontmatter":{"slug":"/blog/why-did-i-want-to-stop-using-jquery-as-much-as-i","date":"Sun, 16 Feb 2014 21:01:02 GMT","title":"Why did I want to stop using jQuery as much as I can and move on to AngularJS","epoch":"1392584462"},"markdownBody":"\n\nI didn’t like to use jQuery very much when I started building Peatix. What I didn’t like most was the fact that by merely writing $(’.class-yeah-its-just-a-marker’) you could jump here from there and everywhere. I am a crazy old man. I learned how to program by learning Structured Programming. Yes, that “avoid goto, everything you write you can write in a sequence, loop or conditional blocks”. Yeah I am old. What are you looking at?\n\nTo me jQuery selector is a GOTO in BASIC (and any other languages). It’s actually a feature that only advanced programmers can use it correctly for a few correct reasons. Yet similar to GOTO in BASIC, it is always those someones who are not real programmers who don’t have solid understanding of whatever programming paradigm who tend to use jQuery. And the code written by those someones breaks my beautifully structured, object oriented, whatever what'ed code.\n\nWell, jQuery is not to be blamed. JQuery is great. JQuery saved us a lot. But it’s time for me to move on to more structured way of writing frontend code.\n\nEnter AngularJS. Until last week I only took a few glances of its tutorial, and read a few articles about it. It sounded like you would be able to separate your HTML completely from someone else’s jQuery. It sounded nice.\n\nI started writing my first AngularJS controller. The web site that I took had a simple search function and the backend API is quite nicely written by my colleague. I only had to move the code that was written with Underscore and jQuery to AngularJS.\n\nIt turned out it was actually mere three days job to fully migrate the page to be based on AngularJS. Part of the reason is that the page was already well separated into logic and view thanks to my colleague. I saw a few holes in here and there while I was working on that page, which I will explain in the following entry.\n\nSo far I like how I write AngularJS controller and a few helper modules, and tests. It doesn’t make me feel anxious like jQuery did when I wrote a jQuery selector that was too vulnerable to a change to HTML/CSS.\n\n"},{"frontmatter":{"slug":"/blog/moved-to-t-mobile","date":"Sun, 09 Feb 2014 20:54:00 GMT","title":"Moved to T-Mobile","epoch":"1391979240"},"markdownBody":"\n\nI have been on Straight Talk $45 plan for two months after I got a Nexus 5. It has been very fine (I’m in Manhattan, New York most of the time) but I used the line in a very limited amount of time.\n\nI also see that I will be accompanied by someone daily real soon, which means she will also need a phone line. Then I remembered [the post by Tatsuhiko about how T-Mobile was awesome](http://weblog.bulknews.net/post/68863788422/t-mobile-global-roaming-awesome). We will also occasionally go abroad (Japan mostly), and I have already had issues that I haven’t had a cell phone line while I was in Tokyo several times by now. If T-Mobile family plan with unlimited international roaming (data and text) works for him, it should work well for us too.\n\nThe concern though is that T-Mobile doesn’t have too good reputation regarding coverage and quality of bandwidth. \n\nCall drops, LTE unstable, narrower coverage, weaker signals, etc. Well, since I am on a sim-free phone, I can test drive it for a month with a prepaid plan and see how/if it works, can’t I?\n\nIt turned out that [Walmart has this value offer that you can get unlimited text and data (first 5GB on LTE) and 100 minutes of talk](http://www.walmart.com/ip/T-Mobile-SIM-Kit/24099996). I don’t need many talk minutes (hey, I received exactly 2 calls from someone, and called absolutely nobody in these few months over cell phone), I probably need some data. Straight Talk was 2.5GB on LTE in 30 days cycle. That’s doubled on this T-Mobile/Walmart plan.\n\nSo, here I am; I just activated my Nexus 5 on the T-mo line. Let’s see how the carrier is “the fastest nationwide 4G LTE network” as it is advertising as of Feb. 2014.\n\n"},{"frontmatter":{"slug":"/blog/david-heinemeier-hansson-at-startup-school-2008","date":"Wed, 05 Feb 2014 21:01:00 GMT","title":"David Heinemeier Hansson at Startup School 2008","epoch":"1391634060"},"markdownBody":"\n\nDavid Heinemeier Hansson at Startup School 2008 (with slides)\n\n[https://www.youtube.com/watch?v=0CDXJ6bMkMY](https://www.youtube.com/watch?v=0CDXJ6bMkMY)\n\nIt was from 5 years ago??? Yet it is so relevant to me, to us right now. I don’t have much idea about what VCs would do to you because I only met one and only one person from a VC in person. And I wasn’t too impressed on what he was trying to tell us; I didn’t see anything relevant to the state of our company at the point when I heard him talking. He was too loud to be ignored either.\n\nI don’t know if it would be better not to get a VC on board, but I know that without their money we are not where where we are today because we would have run out of money. But then again, does it have to be that way, that we hire this many people, have a decent office, run this many servers and pay this money to some  web services that can be replaced with a few OSS stack.\n\n"},{"frontmatter":{"slug":"/blog/collecting-pictures-using-instagram-api","date":"Sun, 02 Feb 2014 20:33:00 GMT","title":"Collecting pictures using Instagram API","epoch":"1391373180"},"markdownBody":"\n\nInstagram has an API. That’s good. But its document was a little bit confusing to me. This is how I ended up implementing Perl code that populates Instagram pictures that have a hashtag of my interest.\n\nFirst confusion - is authentication required or not?\n----------------------------------------------------\n\nTo get information of pictures with a hashtag, Instagram API offers “Tag” endpoints. [The document about Tag endpoint](http://instagram.com/developer/endpoints/tags/)s says though it requires authentication, thus requires access_token parameter. But wait, whose access_token does it require, when all I want is information about publicly viewable photos with a hashtag?\n\nI thought it didn’t make sense to give my own access_token that does work on behalf of my own user account. Or any user account. My intention was to implement a backend service that works periodically to collect pictures with certain hashtags. I just ignored the document and just gave my app’s client_id that I generated on Instagram console. As expected, it worked.\n\n### Point #1: you probably don’t need access_token and all of those pita steps to get OAuth2 access token from a user account.\n\nSecond confusion: how do I paginate the results to get more results?\n--------------------------------------------------------------------\n\nTwitter API does a great job by offering since_id and max_id parameters, so we as a client developer doesn’t have to consider duplicated tweets from two result sets from API calls. [Twitter documentation about “Working with Timelines”](https://dev.twitter.com/docs/working-with-timelines) is really well written and easy to understand what we should do.\n\nSince Instagram offers same type of data that is a stream of posts ordered by pictures posted descending, it has similar pagination parameters; it is only more confusing.\n\nInstagram API names those paramters as max_tag_id and min_tag_id. [Instagram API also returns “pagination” meta data](http://instagram.com/developer/endpoints/#pagination) in API results, which has “next_url” value which looks something like this\n\n[https://api.instagram.com/v1/tags/puppy/media/recent?client_id=xxx\u0026max_tag_id=1391400658711](https://api.instagram.com/v1/tags/puppy/media/recent?client_id=xxx\u0026max_tag_id=1391400658711)\n\nIt also carries two more important values\n\n```\n{  \n    \"next_max_tag_id\":\"1391400658711\",  \n    \"min_tag_id\":\"1391400689156\"  \n}\n```\n\nCalling the API by using the next_url value (note that it has the same id as next_max_tag_id has) returns the next set of results which carries the newest pictures whose id is less than max_tag_id.\n\nAs my goal is to get pictures periodically, storing next_max_tag_id for the next iteration doesn’t make sense because specifying that value narrows down the results to something that I always have collected.\n\nSo, I rather stored min_tag_id and called the API next time with something like \n\n[https://api.instagram.com/v1/tags/puppy/media/recent?client_id=xxx\u0026min_tag_id=1391400658711](https://api.instagram.com/v1/tags/puppy/media/recent?client_id=xxx\u0026min_tag_id=1391400658711)\n\nUnfortunately, this returned nothing. It was obvious after a few more experiments and scratching my head, that because what I wanted was pictures posted after the biggest id, but Instagram calls it “min_tag_id”! Instagram calls it small ids as “max”, or “next” when in fact it is actually about getting older data, instead of new data that I assumed.\n\nSo the final code of mine stores the “min_tag_id” in the database for the next iteration, and calls the API with min_tag_id=\u003cstored min_tag_id\u003e, to avoid getting data that is already in our database.\n\n### Point #2: “max” and “next” could mean different things to different heads.\n\nIn my humble opinion though, Twitter API does smarter job here as it called those parameters as since_id and max_id, less confusing at least to me.\n\n"},{"frontmatter":{"slug":"/blog/migrating-google-login-from-openid-20-to-google-3","date":"Sun, 26 Jan 2014 18:03:00 GMT","title":"Migrating Google login from OpenID 2.0 to Google+ (Part 3 of 3)","epoch":"1390759380"},"markdownBody":"\n([Part 1 of this story](/blog/migrating-google-login-from-openid-20-to-google-1))\n\nGoogle+ Sign In returns id_token that is a JWT encoded information of various stuff related to the account, along with access_token which could be used to call other Google APIs. In order to get the OpenID ident for the user, I had to decode JWT and that requires a key to decode it.\n\n[According to another document about how to validate id_token](https://developers.google.com/accounts/docs/OAuth2Login#validatinganidtoken), the key is a x509 public key whose private key is used to sign the JWT. According to the same document, the key could be retrieved by going to [https://www.googleapis.com/oauth2/v1/certs](https://www.googleapis.com/oauth2/v1/certs). Simple wget returned this.\n\n```\n{\n  \"5f1f4e771e997d21a08add83acbf18c6cb4e5473\": \"-----BEGIN CERTIFICATE-----\\nMIICIDCCAYm..Mh+Y=\\n-----END CERTIFICATE-----\\n\",\n \"729d763c1d8254b3a7f8dd6df19edea7ca836b7b\": \"-----BEGIN CERTIFICATE-----\\nMIICITCC...DeQG1z\\n-----END CERTIFICATE-----\\n\"\n}\n```\n\nThere are two. Which one was used? Going back to the [JWT spec](https://metacpan.org/pod/JSON::WebToken) turned out that a \"JWT is represented as a sequence of URL-safe parts separated by period (\".\") characters\". And after also reading through the code of the cpan module, I tried to decode the first part of MIME encoded JWT.\n\n\n```\n1\u003e x MIME::Base64::decode_base64( substr( $id_token, 0, index( $id_token, '.' ) ) );\n{\"alg\":\"RS256\",\"kid\":\"5f1f4e771e997d21a08add83acbf18c6cb4e5473\"}\n```\n\nYeah, the \"kid\" is what I just saw in the JSON returned from /certs endpoint from Google. This should be what $key should have.\n\n```\n2\u003e $key = \"-----BEGIN CERTIFICATE-----\\nMIICIDCCAYm..Mh+Y=\\n-----END CERTIFICATE-----\\n\",\n3\u003e x JSON::WebToken-\u003edecode($id_token, $key);\nunrecognized key format\n```\n\nOh cpan module, how I \u0026hellip;. what?\n\nFast forward what really happened during my struggle to find it out, it turned out that the error was from [Crypt::OpenSSL::RSA](http://api.metacpan.org/source/PERLER/Crypt-OpenSSL-RSA-0.28/RSA.pm), because it doesn't accept a certificate, but does a public key. Of course. Simple openssl command should give it to me.\n\n```\n$ openssl x509 -pubkey\n-----BEGIN CERTIFICATE-----\nMIICIDCCAYm\n...\nMh+Y=\n-----END CERTIFICATE-----\n-----BEGIN PUBLIC KEY-----\nMIGfMA0GCSqGSIb3DQE\n...\n```\n\nGiving this public key as $key finally gave me what I wanted.\n\n```\n$VAR1 = {\n  'exp' =\u003e 1390759437,\n 'iss' =\u003e 'accounts.google.com',\n'openid_id' =\u003e 'https://www.google.com/accounts/o8/id?id=AItOawkFEXN4pg8u52IM_YLN86LIolXUxqKrU3M',\n'sub' =\u003e '11843998...',\n 'azp' =\u003e '...',\n 'iat' =\u003e 1390755537,\n...\n };\n```\n\nAaaahhhh, it was about 3 hours of writing code, reading documents, experimenting and failing and starting over, but here I got my OpenID ident by logging in through Google+ Sign In. With this and \"sub\" key, Peatix can now find an account associated to an Google account no matter if the user was created by our OpenID implementation before, or by the new Google+ implementation.\n\nFinally, **big kudos to Google**. Google does a good job of supporting long-time users of their API backend. Seriously, it was really easy in the end, after I was able to decode the statement \"data-openidrealm is what you need\" to something like\n\n```\n\"Yeah, Google should not have implemented two separate code in order to support both Hybrid and Pure server flow; that means I should be able to specify this \"openidrealm\" somewhere in my pure OAuth2 code.\"\n```\n\n\nAfter decoding the statement to something like that, I was able to find other mentions to openid.realm in their documents, which told me how to do Pure server-side OpenID migration.\n\n"},{"frontmatter":{"slug":"/blog/migrating-google-login-from-openid-20-to-google-2","date":"Sun, 26 Jan 2014 17:15:00 GMT","title":"Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)","epoch":"1390756500"},"markdownBody":"\n\n([Part 1 of this story](/blog/migrating-google-login-from-openid-20-to-google-1))\n\n\nGoogle published an article in December 2013 that says \"[Upgrading to Google+ Sign In](https://developers.google.com/+/api/auth-migration)\". There it says that if you add \"data-openidrealm\" to your G+ button, you could get the user\"s OpenID ident. Woah! That will solve my problem!\n\n\nReading through the document, though, turned out that it might not be that easy - because the document tells how to do that only by using either Client-side flow of Hybrid server-side flow - some things they recommend. Our sign-in however is completely done in Pure server-side flow (because it was OpenID before). Migrating the \"Login\" button itself to adapt to Hybrid flow is not impossible but it will be painful.\n\n\nSo, I started to hack over the document. The document basically says you just add your OpenID realm (or [trust_root](https://metacpan.org/pod/Net::OpenID::ClaimedIdentity#trust_root)) to data-openidrealm attribute to your button\"s element, and it does all the heavy lifting. It then links to the [page that describes OpenID Connect.](https://developers.google.com/accounts/docs/OpenID#openid-connect) It says that\n\n\n```\nFor applications that use OpenID 2.0, the authentication request URI may include an openid.realm parameter.\n```\n\n\nOK that\"s what I want to hear. So this code should do\n\n\n```\nmy $uri = URI-\u003enew( 'https://accounts.google.com/o/oauth2/auth' );\n $uri-\u003equery_form(\n client_id =\u003e _config()-\u003e{ client_id }\n , response_type =\u003e 'code'\n , scope =\u003e 'https://www.googleapis.com/auth/plus.login'\n , access_type =\u003e 'online'\n , redirect_uri =\u003e _redirect_uri()\n , state =\u003e time()\n , 'openid.realm' =\u003e 'http://peatix.com'\n );\n return $c-\u003eres-\u003eredirect( $uri );\n```\n\n\nThe only part that is really different from what we use for Facebook login (which is also based on OAuth2 but different draft version) is the last argument that sets \u0026lsquo;openid.realm\".\n\n\nThe response to the /token endpoint was something like this\n\n\n```\n{\n \"access_token\" : \"...\",\n \"token_type\" : \"Bearer\",\n \"expires_in\" : 3600,\n \"id_token\" : \"eyJhbGciOiJSUzI1NiIsImtpZCI6IjVmMWY0ZTc3MWU5OTdkMjFhMDhhZGQ4M2FjYmYxOGM2Y2I0ZTU0NzMifQ.eyJ...\"\n}\n```\n\n\n\u0026hellip; well, where is my OpenID ident?\n\n\nI went back to the [OpenID Connect page](https://developers.google.com/accounts/docs/OpenID#map-identifiers) again and found that id_token is what should bear it inside. OK. what is this id_token thing?\n\n\nId_token is encoded in the format called JSON WebToken. It\"s basically cryptographically signed JSON. I must decode this in order to get the OpenID ident. Searching metacpan.org easily found this gem, er, cpan module, [JSON::WebToken](https://metacpan.org/pod/JSON::WebToken). Oh Perl mongers, how I love thou! Now I just need to `cpanm JSON::WebToken` and call JSON::WebToken-\u003edecode( $res-\u003e{ id_token }, $key ). Wait, what should I use as $key?\n\n\nNext up: [finding the key to decode JWT](/blog/migrating-google-login-from-openid-20-to-google-3).\n\n"},{"frontmatter":{"slug":"/blog/migrating-google-login-from-openid-20-to-google-1","date":"Sun, 26 Jan 2014 16:30:00 GMT","title":"Migrating Google login from OpenID 2.0 to Google+ (Part 1 of 3)","epoch":"1390753800"},"markdownBody":"\n\nWe've been allowing users to use their Google accounts to login to Peatix. Until yesterday, however, the code was based on OpenID 2.0 protocol.\n\n```\ncommit   \nAuthor: Fumiaki Yoshimatsu  \nDate: Mon Sep 12 05:08:37 2011 +0000  \n Added Google OpenID to the list of signin-able external service.\n```\n\nWhen I thought I’d implement Google login, there have been two options (iirc); OpenID or OAuth 1.0a. IIRC, OAuth2 based login protocol was still in beta or something that it could change later. At that time around September 2011, people still believed that OAuth2 would obsolete OAuth 1.0a. Well, OAuth2 could change, OAuth1 has no future, I’d had to say OpenID was the best choice. And I implemented it.\n\nFast forward two years, It’s got obvious that\n\n*   [OAuth2 is a dead end](http://hueniverse.com/2012/07/on-leaving-oauth/). At least as an “authentication protocol”.\n*   OpenID lives and lives well, although “techy”(cough cough) people tends to see OpenID dead.\n*   OAuth 1.0a lives in a good shape - Twitter won the bet.\n\nIn other words, in a discussion of “which authentication protocol should I use in 2014?”, OpenID is still not a bad choice.\n\nWhen it comes to Google login however, there is a different story. “Google+” login that Google is encouraging to implement is based on OAuth2 protocol. And it gives you many benefits over OpenID - seamless login between Android and web for example. By 2014, it became natural for me to want to migrate our OpenID based authentication to Google+.\n\nI started research around that idea around June 2013 (that was when I filed a story in our Pivotal Tracker project). There were two simple requirements:\n\n*   Users can login via Google+ / OAuth2 protocol\n*   Existing users with Google OpenID associated to their accounts can still login to land to the same Peatix account without too much hassle\n\nThe second part was tough though, because we only keep [$verified_identity-\u003eurl](https://metacpan.org/pod/Net::OpenID::VerifiedIdentity#vident-url) in our storage which looks like this\n\n[https://www.google.com/accounts/o8/id?id=AItOawkFEXN4pg8u52IM_YLN86LIolXUxqKrU3M](https://www.google.com/accounts/o8/id?id=AItOawkFEXN4pg8u52IM_YLN86LIolXUxqKrU3M)\n\nAnd it didn’t seem like Google would give us both Google+ ID and OpenID for an account so Peatix could match two to migrate the user to Google+ in a seamless manner.\n\nIt didn’t seem like so, until December 2013.\n\nTo be continued to [Part 2 of this story about migrating Google OpenID to Google+](/blog/migrating-google-login-from-openid-20-to-google-2).\n\n"},{"frontmatter":{"slug":"/blog/reloaded","date":"Sun, 26 Jan 2014 15:55:29 GMT","title":"Reloaded","epoch":"1390751729"},"markdownBody":"\n\nIt’s been a while since I posted the last entry to my blog. Two years later, I think I thought I’d restart blogging again.\n\n"}]},"__N_SSG":true},"page":"/blog","query":{},"buildId":"Eykl4FuNXE5myoJU2Cb5e","runtimeConfig":{},"nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e0a799dda1546678fa28.js"></script><script src="/_next/static/chunks/main-fd8a0b253a51098ec3a6.js" async=""></script><script src="/_next/static/chunks/webpack-488dc228921f1fdbc0e7.js" async=""></script><script src="/_next/static/chunks/framework.1b5fae6dde8a26be77ac.js" async=""></script><script src="/_next/static/chunks/e82d01500e11e0131e78851aa17fd9f5e63d6c88.616ccd5db4903f86882e.js" async=""></script><script src="/_next/static/chunks/pages/_app-7fedf4f2cd6f1ab3e039.js" async=""></script><script src="/_next/static/chunks/pages/blog-28dab01dc9e079f7ef39.js" async=""></script><script src="/_next/static/Eykl4FuNXE5myoJU2Cb5e/_buildManifest.js" async=""></script><script src="/_next/static/Eykl4FuNXE5myoJU2Cb5e/_ssgManifest.js" async=""></script></body></html>