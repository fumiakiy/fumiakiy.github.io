<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Custom async iterator in JavaScript</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@fumiakiy"/><meta name="og:title" content="Custom async iterator in JavaScript"/><meta name="twitter:title" content="Custom async iterator in JavaScript"/><meta name="description" content="Today I learned how to implement and use an custom async iterator in JavaScript."/><meta name="og:description" content="Today I learned how to implement and use an custom async iterator in JavaScript."/><meta name="twitter:description" content="Today I learned how to implement and use an custom async iterator in JavaScript."/><link rel="prev" href="https://luckypines.com/blog/2021-08-27-dmv-road-test-astoria-heights-1"/><link rel="next" href="https://luckypines.com/blog/2021-10-21-dmv-road-test-astoria-heights-2"/><meta name="next-head-count" content="12"/><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-50700-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag("js", new Date());
  gtag("config", "UA-50700-3");

  window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
  
    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };
  
    return t;
  }(document, "script", "twitter-wjs"));
  </script><link rel="alternate" type="application/atom+xml" title="Atom feed for blog by Fumiaki Yoshimatsu" href="https://luckypines.com/feed.atom"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/a233f8e7bb0aab01.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a233f8e7bb0aab01.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a85ef328f9b29345.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a85ef328f9b29345.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-f635b472c367d1c7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3c378216e12a202e.js" defer=""></script><script src="/_next/static/chunks/929-7a82b6373bf08faf.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bpostname%5D-5b6da21245e44f1e.js" defer=""></script><script src="/_next/static/MMbr61BuVy2HTEs4nWpbA/_buildManifest.js" defer=""></script><script src="/_next/static/MMbr61BuVy2HTEs4nWpbA/_ssgManifest.js" defer=""></script><script src="/_next/static/MMbr61BuVy2HTEs4nWpbA/_middlewareManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap">@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vqPQA.woff) format('woff')}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_7PqPQA.woff) format('woff')}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_Of2PQA.woff) format('woff')}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSV0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSx0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSt0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSd0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSZ0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSh0me8iUI0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSV0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSx0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSt0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSd0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSZ0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSh0me8iUI0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSV0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSx0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSt0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSd0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSZ0me8iUI0lkQ.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto Mono';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xTDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vrtSM1J-gEPT5Ese6hmHSh0me8iUI0.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><div class="blog"><article class="BlogPost_article__wA_OL"><h1>Custom async iterator in JavaScript</h1><div>9/3/2021, 10:03:09 AM</div><div class="BlogPost_body__N7rlb"><div>You can write an async iterator/generator of your own in JavaScript.</div>
<div>The motivation behind the idea was that</div>
<ol>
<li>I wanted to call AWS.Comprehend.batchDetectEntities and pass 309 items of texts in an array.</li>
<li>When I did the first time, AWS returned &quot;Throttoling Exception&quot;. It turned out that the current settings allow only 10 items per second and a &quot;batch&quot; call is considered as N calls (number of calls in a batch call) not a call for the quota.</li>
<li>So I thought I would split the array of texts into pieces so each piece has 10 items in it, and call the API over and over with 2 seconds interval.</li>
</ol>
<div>It would be something like this:</div>
<pre><code>async function getPiece(data) {
    const piece = data.splice(0, Math.min(10, data.length))
    await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
    return piece
}

const data = [ ... ]
(async () =&gt; {
    const results = []
    const cloned = [...data]
    while (cloned.length &gt; 0) {
        const piece = await getPiece(cloned)
        const result = await AwsApiCall(piece)
        results.push(result)
    }
    console.log(results)
})()
</code></pre>
<div>It waits 2 seconds and then pulls out the first 10 items from inputs and calls AWS API with the set of 10 items, process the result and see if there are more inputs.</div>
<div>It works, but I felt itchy because the content of the inputs or <code>cloned</code> at a particular moment was ambiguous from the code. The <code>getPiece</code> function modifies the content of <code>cloned</code> which is not obvious from the main function, but the main function is relying on the fact that the content would eventually become empty.</div>
<div>There could be many ways to write cleaner code than this. For example, the number of times the loop in the main function should iterate can be pre-calculated in the main function, thus it&#x27;s not necessary for the main function to rely on the <code>getPiece</code> function to manage the content of inputs.</div>
<div>But I found it easy to use a generator/iterator here. The similar code could be written like this if we use an async generator:</div>
<pre><code>async function* dataSplitter(data) {
    const cloned = [...data]
    while (cloned.length &gt; 0) {
        const piece = cloned.splice(0, Math.min(10, cloned.length))
        await new Promise((resolve) =&gt; setTimeout(resolve, 2000));
        yield piece
    }
}

const data = [ ... ]
(async () =&gt; {
    const results = []
    for await (const piece of dataSplitter(data)) {
        const result = await AwsApiCall(piece)
        results.push(result)
    }
    console.log(results)
})()
</code></pre>
<div>The <code>dataSplitter</code> yields 10 items every 2 seconds until there are no more data, and the main function doesn&#x27;t have to know how it manages the content of the data. All the main function has to do is to call the AWS API for each piece that the generator yields in the <code>for await of</code> loop which was also new to me.</div></div></article></div><footer class="BlogPost_footer__4tSVP"><a class="BlogPost_prev__r_UG_" href="/blog/2021-08-27-dmv-road-test-astoria-heights-1/">« <!-- -->ニューヨークで運転免許取得のための路上試験を受けて落ちた</a><a href="/blog/">Blog</a><a class="BlogPost_next__kILUp" href="/blog/2021-10-21-dmv-road-test-astoria-heights-2/">ニューヨークで運転免許を取得した<!-- --> » </a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"slug":"/blog/js-til-2021-09-03","date":"Fri, 03 Sep 2021 14:03:09 GMT","title":"Custom async iterator in JavaScript","epoch":"1630677789","excerpt":"Today I learned how to implement and use an custom async iterator in JavaScript."},"markdownBody":"\nYou can write an async iterator/generator of your own in JavaScript.\n\nThe motivation behind the idea was that\n\n1. I wanted to call AWS.Comprehend.batchDetectEntities and pass 309 items of texts in an array.\n1. When I did the first time, AWS returned \"Throttoling Exception\". It turned out that the current settings allow only 10 items per second and a \"batch\" call is considered as N calls (number of calls in a batch call) not a call for the quota.\n1. So I thought I would split the array of texts into pieces so each piece has 10 items in it, and call the API over and over with 2 seconds interval.\n\nIt would be something like this:\n\n```\nasync function getPiece(data) {\n    const piece = data.splice(0, Math.min(10, data.length))\n    await new Promise((resolve) =\u003e setTimeout(resolve, 2000));\n    return piece\n}\n\nconst data = [ ... ]\n(async () =\u003e {\n    const results = []\n    const cloned = [...data]\n    while (cloned.length \u003e 0) {\n        const piece = await getPiece(cloned)\n        const result = await AwsApiCall(piece)\n        results.push(result)\n    }\n    console.log(results)\n})()\n```\n\nIt waits 2 seconds and then pulls out the first 10 items from inputs and calls AWS API with the set of 10 items, process the result and see if there are more inputs.\n\nIt works, but I felt itchy because the content of the inputs or `cloned` at a particular moment was ambiguous from the code. The `getPiece` function modifies the content of `cloned` which is not obvious from the main function, but the main function is relying on the fact that the content would eventually become empty.\n\nThere could be many ways to write cleaner code than this. For example, the number of times the loop in the main function should iterate can be pre-calculated in the main function, thus it's not necessary for the main function to rely on the `getPiece` function to manage the content of inputs.\n\nBut I found it easy to use a generator/iterator here. The similar code could be written like this if we use an async generator:\n\n```\nasync function* dataSplitter(data) {\n    const cloned = [...data]\n    while (cloned.length \u003e 0) {\n        const piece = cloned.splice(0, Math.min(10, cloned.length))\n        await new Promise((resolve) =\u003e setTimeout(resolve, 2000));\n        yield piece\n    }\n}\n\nconst data = [ ... ]\n(async () =\u003e {\n    const results = []\n    for await (const piece of dataSplitter(data)) {\n        const result = await AwsApiCall(piece)\n        results.push(result)\n    }\n    console.log(results)\n})()\n```\n\nThe `dataSplitter` yields 10 items every 2 seconds until there are no more data, and the main function doesn't have to know how it manages the content of the data. All the main function has to do is to call the AWS API for each piece that the generator yields in the `for await of` loop which was also new to me.\n","navs":{"nextPage":{"epoch":"1635001192","title":"ニューヨークで運転免許を取得した","slug":"/blog/2021-10-21-dmv-road-test-astoria-heights-2"},"prevPage":{"epoch":"1630087252","title":"ニューヨークで運転免許取得のための路上試験を受けて落ちた","slug":"/blog/2021-08-27-dmv-road-test-astoria-heights-1"}}},"__N_SSG":true},"page":"/blog/[postname]","query":{"postname":"js-til-2021-09-03"},"buildId":"MMbr61BuVy2HTEs4nWpbA","runtimeConfig":{},"isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>