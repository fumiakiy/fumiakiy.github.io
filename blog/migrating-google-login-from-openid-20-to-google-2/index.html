<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-50700-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {dataLayer.push(arguments); }
    gtag("js", new Date());

    gtag("config", "UA-50700-3");
 </script><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&amp;display=swap" rel="stylesheet"/><link rel="alternate" type="application/atom+xml" title="Atom feed for blog by Fumiaki Yoshimatsu" href="https://luckypines.com/feed.atom"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)</title><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@fumiakiy"/><meta name="og:title" content="Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)"/><meta name="twitter:title" content="Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)"/><link rel="prev" href="https://luckypines.com/blog/migrating-google-login-from-openid-20-to-google-1"/><link rel="next" href="https://luckypines.com/blog/migrating-google-login-from-openid-20-to-google-3"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/64b34ea9b2889faf28d8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/64b34ea9b2889faf28d8.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9b0bc77bc3188cb01e3f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9b0bc77bc3188cb01e3f.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-591f24fdf217128ccce8.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.0c239260661ae1d12aa2.js" as="script"/><link rel="preload" href="/_next/static/chunks/c332eec026863555a27dac51ec167aa1a0b2daea.b0d8b3a553c082c94749.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-bcebaf8643a439c67406.js" as="script"/><link rel="preload" href="/_next/static/chunks/447cfa7d44c888c772d6119f6f6093046de0bb36.df9ec102d8f274c4414d.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bpostname%5D-6b0db52313629d37408b.js" as="script"/></head><body><div id="__next"><div class="blog"><article class="BlogPost_article__3W1r-"><h1>Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)</h1><div>1/26/2014, 12:15:00 PM</div><div class="BlogPost_body__1oPZH"><div>(<a href="/blog/migrating-google-login-from-openid-20-to-google-1">Part 1 of this story</a>)</div><div>Google published an article in December 2013 that says &quot;<a href="https://developers.google.com/+/api/auth-migration">Upgrading to Google+ Sign In</a>&quot;. There it says that if you add &quot;data-openidrealm&quot; to your G+ button, you could get the user&quot;s OpenID ident. Woah! That will solve my problem!</div><div>Reading through the document, though, turned out that it might not be that easy - because the document tells how to do that only by using either Client-side flow of Hybrid server-side flow - some things they recommend. Our sign-in however is completely done in Pure server-side flow (because it was OpenID before). Migrating the &quot;Login&quot; button itself to adapt to Hybrid flow is not impossible but it will be painful.</div><div>So, I started to hack over the document. The document basically says you just add your OpenID realm (or <a href="https://metacpan.org/pod/Net::OpenID::ClaimedIdentity#trust_root">trust_root</a>) to data-openidrealm attribute to your button&quot;s element, and it does all the heavy lifting. It then links to the <a href="https://developers.google.com/accounts/docs/OpenID#openid-connect">page that describes OpenID Connect.</a> It says that</div><pre><code>For applications that use OpenID 2.0, the authentication request URI may include an openid.realm parameter.</code></pre><div>OK that&quot;s what I want to hear. So this code should do</div><pre><code>my $uri = URI-&gt;new( &#x27;https://accounts.google.com/o/oauth2/auth&#x27; );
 $uri-&gt;query_form(
 client_id =&gt; _config()-&gt;{ client_id }
 , response_type =&gt; &#x27;code&#x27;
 , scope =&gt; &#x27;https://www.googleapis.com/auth/plus.login&#x27;
 , access_type =&gt; &#x27;online&#x27;
 , redirect_uri =&gt; _redirect_uri()
 , state =&gt; time()
 , &#x27;openid.realm&#x27; =&gt; &#x27;http://peatix.com&#x27;
 );
 return $c-&gt;res-&gt;redirect( $uri );</code></pre><div>The only part that is really different from what we use for Facebook login (which is also based on OAuth2 but different draft version) is the last argument that sets ‘openid.realm&quot;.</div><div>The response to the /token endpoint was something like this</div><pre><code>{
 &quot;access_token&quot; : &quot;...&quot;,
 &quot;token_type&quot; : &quot;Bearer&quot;,
 &quot;expires_in&quot; : 3600,
 &quot;id_token&quot; : &quot;eyJhbGciOiJSUzI1NiIsImtpZCI6IjVmMWY0ZTc3MWU5OTdkMjFhMDhhZGQ4M2FjYmYxOGM2Y2I0ZTU0NzMifQ.eyJ...&quot;
}</code></pre><div>… well, where is my OpenID ident?</div><div>I went back to the <a href="https://developers.google.com/accounts/docs/OpenID#map-identifiers">OpenID Connect page</a> again and found that id_token is what should bear it inside. OK. what is this id_token thing?</div><div>Id_token is encoded in the format called JSON WebToken. It&quot;s basically cryptographically signed JSON. I must decode this in order to get the OpenID ident. Searching metacpan.org easily found this gem, er, cpan module, <a href="https://metacpan.org/pod/JSON::WebToken">JSON::WebToken</a>. Oh Perl mongers, how I love thou! Now I just need to <code>cpanm JSON::WebToken</code> and call JSON::WebToken-&gt;decode( $res-&gt;{ id_token }, $key ). Wait, what should I use as $key?</div><div>Next up: <a href="/blog/migrating-google-login-from-openid-20-to-google-3">finding the key to decode JWT</a>.</div></div></article></div><footer class="BlogPost_footer__YgPcw"><a class="BlogPost_prev__2S7U6" href="/blog/migrating-google-login-from-openid-20-to-google-1/">« <!-- -->Migrating Google login from OpenID 2.0 to Google+ (Part 1 of 3)</a><a href="/blog/">Blog</a><a class="BlogPost_next__1yyYz" href="/blog/migrating-google-login-from-openid-20-to-google-3/">Migrating Google login from OpenID 2.0 to Google+ (Part 3 of 3)<!-- --> » </a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"slug":"/blog/migrating-google-login-from-openid-20-to-google-2","date":"Sun, 26 Jan 2014 17:15:00 GMT","title":"Migrating Google login from OpenID 2.0 to Google+ (Part 2 of 3)","epoch":"1390756500"},"markdownBody":"\n\n([Part 1 of this story](/blog/migrating-google-login-from-openid-20-to-google-1))\n\n\nGoogle published an article in December 2013 that says \"[Upgrading to Google+ Sign In](https://developers.google.com/+/api/auth-migration)\". There it says that if you add \"data-openidrealm\" to your G+ button, you could get the user\"s OpenID ident. Woah! That will solve my problem!\n\n\nReading through the document, though, turned out that it might not be that easy - because the document tells how to do that only by using either Client-side flow of Hybrid server-side flow - some things they recommend. Our sign-in however is completely done in Pure server-side flow (because it was OpenID before). Migrating the \"Login\" button itself to adapt to Hybrid flow is not impossible but it will be painful.\n\n\nSo, I started to hack over the document. The document basically says you just add your OpenID realm (or [trust_root](https://metacpan.org/pod/Net::OpenID::ClaimedIdentity#trust_root)) to data-openidrealm attribute to your button\"s element, and it does all the heavy lifting. It then links to the [page that describes OpenID Connect.](https://developers.google.com/accounts/docs/OpenID#openid-connect) It says that\n\n\n```\nFor applications that use OpenID 2.0, the authentication request URI may include an openid.realm parameter.\n```\n\n\nOK that\"s what I want to hear. So this code should do\n\n\n```\nmy $uri = URI-\u003enew( 'https://accounts.google.com/o/oauth2/auth' );\n $uri-\u003equery_form(\n client_id =\u003e _config()-\u003e{ client_id }\n , response_type =\u003e 'code'\n , scope =\u003e 'https://www.googleapis.com/auth/plus.login'\n , access_type =\u003e 'online'\n , redirect_uri =\u003e _redirect_uri()\n , state =\u003e time()\n , 'openid.realm' =\u003e 'http://peatix.com'\n );\n return $c-\u003eres-\u003eredirect( $uri );\n```\n\n\nThe only part that is really different from what we use for Facebook login (which is also based on OAuth2 but different draft version) is the last argument that sets \u0026lsquo;openid.realm\".\n\n\nThe response to the /token endpoint was something like this\n\n\n```\n{\n \"access_token\" : \"...\",\n \"token_type\" : \"Bearer\",\n \"expires_in\" : 3600,\n \"id_token\" : \"eyJhbGciOiJSUzI1NiIsImtpZCI6IjVmMWY0ZTc3MWU5OTdkMjFhMDhhZGQ4M2FjYmYxOGM2Y2I0ZTU0NzMifQ.eyJ...\"\n}\n```\n\n\n\u0026hellip; well, where is my OpenID ident?\n\n\nI went back to the [OpenID Connect page](https://developers.google.com/accounts/docs/OpenID#map-identifiers) again and found that id_token is what should bear it inside. OK. what is this id_token thing?\n\n\nId_token is encoded in the format called JSON WebToken. It\"s basically cryptographically signed JSON. I must decode this in order to get the OpenID ident. Searching metacpan.org easily found this gem, er, cpan module, [JSON::WebToken](https://metacpan.org/pod/JSON::WebToken). Oh Perl mongers, how I love thou! Now I just need to `cpanm JSON::WebToken` and call JSON::WebToken-\u003edecode( $res-\u003e{ id_token }, $key ). Wait, what should I use as $key?\n\n\nNext up: [finding the key to decode JWT](/blog/migrating-google-login-from-openid-20-to-google-3).\n\n","navs":{"nextPage":{"epoch":"1390759380","title":"Migrating Google login from OpenID 2.0 to Google+ (Part 3 of 3)","slug":"/blog/migrating-google-login-from-openid-20-to-google-3"},"prevPage":{"epoch":"1390753800","title":"Migrating Google login from OpenID 2.0 to Google+ (Part 1 of 3)","slug":"/blog/migrating-google-login-from-openid-20-to-google-1"}}},"__N_SSG":true},"page":"/blog/[postname]","query":{"postname":"migrating-google-login-from-openid-20-to-google-2"},"buildId":"ncHs5kG0iheRP5qhiPI3D","runtimeConfig":{},"nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-af28de04c604a2479390.js"></script><script src="/_next/static/chunks/main-591f24fdf217128ccce8.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.0c239260661ae1d12aa2.js" async=""></script><script src="/_next/static/chunks/c332eec026863555a27dac51ec167aa1a0b2daea.b0d8b3a553c082c94749.js" async=""></script><script src="/_next/static/chunks/pages/_app-bcebaf8643a439c67406.js" async=""></script><script src="/_next/static/chunks/447cfa7d44c888c772d6119f6f6093046de0bb36.df9ec102d8f274c4414d.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bpostname%5D-6b0db52313629d37408b.js" async=""></script><script src="/_next/static/ncHs5kG0iheRP5qhiPI3D/_buildManifest.js" async=""></script><script src="/_next/static/ncHs5kG0iheRP5qhiPI3D/_ssgManifest.js" async=""></script></body></html>